/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { isIE } from './../../../../utils/util';
import { PoKeyCodeEnum } from './../../../../enums/po-key-code.enum';
/** @type {?} */
var poRichTextBodyCommands = [
    'bold', 'italic', 'underline', 'justifyleft', 'justifycenter', 'justifyright', 'justifyfull', 'insertUnorderedList', 'Createlink'
];
var PoRichTextBodyComponent = /** @class */ (function () {
    function PoRichTextBodyComponent() {
        this.change = new EventEmitter();
        this.commands = new EventEmitter();
        this.shortcutCommand = new EventEmitter();
        this.value = new EventEmitter();
    }
    /**
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.bodyElement.nativeElement.designMode = 'on';
        // timeout necessário para setar o valor vindo do writeValue do componente principal.
        setTimeout((/**
         * @return {?}
         */
        function () { return _this.updateValueWithModelValue(); }));
    };
    /**
     * @param {?} command
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.executeCommand = /**
     * @param {?} command
     * @return {?}
     */
    function (command) {
        this.bodyElement.nativeElement.focus();
        if (typeof (command) === 'object') {
            if (command.command === 'InsertHTML') {
                var linkCommand = command.command, urlLink = command.value.urlLink, urlLinkText = command.value.urlLinkText;
                this.handleCommandLink(linkCommand, urlLink, urlLinkText);
            }
            else {
                document.execCommand(command.command, false, command.value);
            }
        }
        else {
            document.execCommand(command, false, null);
        }
        this.updateModel();
        this.value.emit(this.modelValue);
    };
    /**
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.onBlur = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.modelValue !== this.valueBeforeChange) {
            clearTimeout(this.timeoutChange);
            this.timeoutChange = setTimeout((/**
             * @return {?}
             */
            function () {
                _this.change.emit(_this.modelValue);
            }), 200);
        }
    };
    /**
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.focus = /**
     * @return {?}
     */
    function () {
        this.bodyElement.nativeElement.focus();
    };
    /**
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.onClick = /**
     * @return {?}
     */
    function () {
        this.emitSelectionCommands();
    };
    /**
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.onFocus = /**
     * @return {?}
     */
    function () {
        this.valueBeforeChange = this.modelValue;
    };
    /**
     * @param {?} event
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.onKeyDown = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        /** @type {?} */
        var keyL = event.keyCode === PoKeyCodeEnum.keyL;
        if (keyL && event.ctrlKey || keyL && event.metaKey) {
            event.preventDefault();
            this.shortcutCommand.emit();
        }
    };
    /**
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.onKeyUp = /**
     * @return {?}
     */
    function () {
        // Tratamento necessário para eliminar a tag <br> criada no firefox quando o body for limpo.
        /** @type {?} */
        var bodyElement = this.bodyElement.nativeElement;
        if (!bodyElement.innerText.trim() && bodyElement.childNodes.length === 1 && bodyElement.querySelector('br')) {
            bodyElement.querySelector('br').remove();
        }
        this.updateModel();
        this.emitSelectionCommands();
    };
    /**
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.update = /**
     * @return {?}
     */
    function () {
        var _this = this;
        setTimeout((/**
         * @return {?}
         */
        function () { return _this.updateModel(); }));
        setTimeout((/**
         * @return {?}
         */
        function () { return _this.onKeyUp(); }));
    };
    /**
     * @private
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.cursorPositionedInALink = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var link = document.getSelection();
        return link.focusNode.parentElement.tagName === 'A';
    };
    /**
     * @private
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.emitSelectionCommands = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var commands = poRichTextBodyCommands.filter((/**
         * @param {?} command
         * @return {?}
         */
        function (command) { return document.queryCommandState(command); }));
        /** @type {?} */
        var rgbColor = document.queryCommandValue('ForeColor');
        /** @type {?} */
        var hexColor = this.rgbToHex(rgbColor);
        if (this.cursorPositionedInALink()) {
            commands.push('Createlink');
        }
        this.commands.emit({ commands: commands, hexColor: hexColor });
    };
    /**
     * @private
     * @param {?} linkCommand
     * @param {?} urlLink
     * @param {?} urlLinkText
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.handleCommandLink = /**
     * @private
     * @param {?} linkCommand
     * @param {?} urlLink
     * @param {?} urlLinkText
     * @return {?}
     */
    function (linkCommand, urlLink, urlLinkText) {
        if (isIE()) {
            this.insertHtmlLinkElement(urlLink, urlLinkText);
        }
        else {
            // necessário '&nbsp;' no fim pois o Firefox mantém o cursor dentro da tag;
            /** @type {?} */
            var linkValue = "<a class=\"po-rich-text-link\" href=\"" + urlLink + "\" target=\"_blank\">" + (urlLinkText || urlLink) + "</a>";
            document.execCommand(linkCommand, false, linkValue);
        }
    };
    // tratamento específico para IE pois não suporta o comando 'insertHTML'.
    // tratamento específico para IE pois não suporta o comando 'insertHTML'.
    /**
     * @private
     * @param {?} urlLink
     * @param {?} urlLinkText
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.insertHtmlLinkElement = 
    // tratamento específico para IE pois não suporta o comando 'insertHTML'.
    /**
     * @private
     * @param {?} urlLink
     * @param {?} urlLinkText
     * @return {?}
     */
    function (urlLink, urlLinkText) {
        /** @type {?} */
        var selection = document.getSelection();
        /** @type {?} */
        var selectionRange = selection.getRangeAt(0);
        /** @type {?} */
        var elementLink = document.createElement('a');
        /** @type {?} */
        var elementlinkText = document.createTextNode(urlLinkText);
        elementLink.appendChild(elementlinkText);
        elementLink.href = urlLink;
        elementLink.setAttribute('target', '_blank');
        elementLink.classList.add('po-rich-text-link');
        selectionRange.deleteContents();
        selectionRange.insertNode(elementLink);
    };
    /**
     * @private
     * @param {?} rgb
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.rgbToHex = /**
     * @private
     * @param {?} rgb
     * @return {?}
     */
    function (rgb) {
        // Tratamento necessário para converter o código rgb para hexadecimal.
        /** @type {?} */
        var sep = rgb.indexOf(',') > -1 ? ',' : ' ';
        rgb = rgb.substr(4).split(')')[0].split(sep);
        /** @type {?} */
        var r = (+rgb[0]).toString(16);
        /** @type {?} */
        var g = (+rgb[1]).toString(16);
        /** @type {?} */
        var b = (+rgb[2]).toString(16);
        if (r.length === 1) {
            r = '0' + r;
        }
        if (g.length === 1) {
            g = '0' + g;
        }
        if (b.length === 1) {
            b = '0' + b;
        }
        return '#' + r + g + b;
    };
    /**
     * @private
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.updateModel = /**
     * @private
     * @return {?}
     */
    function () {
        this.modelValue = this.bodyElement.nativeElement.innerHTML;
        this.value.emit(this.modelValue);
    };
    /**
     * @private
     * @return {?}
     */
    PoRichTextBodyComponent.prototype.updateValueWithModelValue = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.modelValue) {
            this.bodyElement.nativeElement.insertAdjacentHTML('afterbegin', this.modelValue);
        }
    };
    PoRichTextBodyComponent.decorators = [
        { type: Component, args: [{
                    selector: 'po-rich-text-body',
                    template: "<div #bodyElement\n  class=\"po-rich-text-body\"\n  tabindex=\"0\"\n  [attr.contenteditable]=\"!readonly\"\n  [attr.data-placeholder]=\"placeholder\"\n  [style.height.px]=\"height\"\n  (blur)=\"onBlur()\"\n  (click)=\"onClick()\"\n  (cut)=\"update()\"\n  (focus)=\"onFocus()\"\n  (keydown)=\"onKeyDown($event)\"\n  (keyup)=\"onKeyUp()\"\n  (paste)=\"update()\">\n</div>\n"
                }] }
    ];
    PoRichTextBodyComponent.propDecorators = {
        bodyElement: [{ type: ViewChild, args: ['bodyElement', { static: true },] }],
        height: [{ type: Input, args: ['p-height',] }],
        modelValue: [{ type: Input, args: ['p-model-value',] }],
        placeholder: [{ type: Input, args: ['p-placeholder',] }],
        readonly: [{ type: Input, args: ['p-readonly',] }],
        change: [{ type: Output, args: ['p-change',] }],
        commands: [{ type: Output, args: ['p-commands',] }],
        shortcutCommand: [{ type: Output, args: ['p-shortcut-command',] }],
        value: [{ type: Output, args: ['p-value',] }]
    };
    return PoRichTextBodyComponent;
}());
export { PoRichTextBodyComponent };
if (false) {
    /**
     * @type {?}
     * @private
     */
    PoRichTextBodyComponent.prototype.timeoutChange;
    /**
     * @type {?}
     * @private
     */
    PoRichTextBodyComponent.prototype.valueBeforeChange;
    /** @type {?} */
    PoRichTextBodyComponent.prototype.bodyElement;
    /** @type {?} */
    PoRichTextBodyComponent.prototype.height;
    /** @type {?} */
    PoRichTextBodyComponent.prototype.modelValue;
    /** @type {?} */
    PoRichTextBodyComponent.prototype.placeholder;
    /** @type {?} */
    PoRichTextBodyComponent.prototype.readonly;
    /** @type {?} */
    PoRichTextBodyComponent.prototype.change;
    /** @type {?} */
    PoRichTextBodyComponent.prototype.commands;
    /** @type {?} */
    PoRichTextBodyComponent.prototype.shortcutCommand;
    /** @type {?} */
    PoRichTextBodyComponent.prototype.value;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LWJvZHkuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBvcnRpbmFyaS9wb3J0aW5hcmktdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wby1maWVsZC9wby1yaWNoLXRleHQvcG8tcmljaC10ZXh0LWJvZHkvcG8tcmljaC10ZXh0LWJvZHkuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFdEcsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQzs7SUFFL0Qsc0JBQXNCLEdBQUc7SUFDN0IsTUFBTSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsYUFBYSxFQUFFLHFCQUFxQixFQUFFLFlBQVk7Q0FDbEk7QUFFRDtJQUFBO1FBbUJzQixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUUvQixhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUUzQixvQkFBZSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFFckQsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7SUEySnJELENBQUM7Ozs7SUF6SkMsMENBQVE7OztJQUFSO1FBQUEsaUJBS0M7UUFKQyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBRWpELHFGQUFxRjtRQUNyRixVQUFVOzs7UUFBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLHlCQUF5QixFQUFFLEVBQWhDLENBQWdDLEVBQUMsQ0FBQztJQUNyRCxDQUFDOzs7OztJQUVELGdEQUFjOzs7O0lBQWQsVUFBZSxP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QUFTOztJQTJKbkIsOEJBQUM7Q0FBQSxBQXBMRCxJQW9MQztTQWhMWSx1QkFBdUI7Ozs7OztJQUVsQyxnREFBMkI7Ozs7O0lBQzNCLG9EQUErQjs7SUFFL0IsOENBQW9FOztJQUVwRSx5Q0FBbUM7O0lBRW5DLDZDQUE0Qzs7SUFFNUMsOENBQTZDOztJQUU3QywyQ0FBdUM7O0lBRXZDLHlDQUFxRDs7SUFFckQsMkNBQXlEOztJQUV6RCxrREFBd0U7O0lBRXhFLHdDQUFtRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25Jbml0LCBPdXRwdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBpc0lFIH0gZnJvbSAnLi8uLi8uLi8uLi8uLi91dGlscy91dGlsJztcbmltcG9ydCB7IFBvS2V5Q29kZUVudW0gfSBmcm9tICcuLy4uLy4uLy4uLy4uL2VudW1zL3BvLWtleS1jb2RlLmVudW0nO1xuXG5jb25zdCBwb1JpY2hUZXh0Qm9keUNvbW1hbmRzID0gW1xuICAnYm9sZCcsICdpdGFsaWMnLCAndW5kZXJsaW5lJywgJ2p1c3RpZnlsZWZ0JywgJ2p1c3RpZnljZW50ZXInLCAnanVzdGlmeXJpZ2h0JywgJ2p1c3RpZnlmdWxsJywgJ2luc2VydFVub3JkZXJlZExpc3QnLCAnQ3JlYXRlbGluaydcbl07XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLXJpY2gtdGV4dC1ib2R5JyxcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLXJpY2gtdGV4dC1ib2R5LmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQb1JpY2hUZXh0Qm9keUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG5cbiAgcHJpdmF0ZSB0aW1lb3V0Q2hhbmdlOiBhbnk7XG4gIHByaXZhdGUgdmFsdWVCZWZvcmVDaGFuZ2U6IGFueTtcblxuICBAVmlld0NoaWxkKCdib2R5RWxlbWVudCcsIHsgc3RhdGljOiB0cnVlIH0pIGJvZHlFbGVtZW50OiBFbGVtZW50UmVmO1xuXG4gIEBJbnB1dCgncC1oZWlnaHQnKSBoZWlnaHQ/OiBzdHJpbmc7XG5cbiAgQElucHV0KCdwLW1vZGVsLXZhbHVlJykgbW9kZWxWYWx1ZT86IHN0cmluZztcblxuICBASW5wdXQoJ3AtcGxhY2Vob2xkZXInKSBwbGFjZWhvbGRlcj86IHN0cmluZztcblxuICBASW5wdXQoJ3AtcmVhZG9ubHknKSByZWFkb25seT86IHN0cmluZztcblxuICBAT3V0cHV0KCdwLWNoYW5nZScpIGNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ3AtY29tbWFuZHMnKSBjb21tYW5kcyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ3Atc2hvcnRjdXQtY29tbWFuZCcpIHNob3J0Y3V0Q29tbWFuZCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ3AtdmFsdWUnKSB2YWx1ZSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5kZXNpZ25Nb2RlID0gJ29uJztcblxuICAgIC8vIHRpbWVvdXQgbmVjZXNzw6FyaW8gcGFyYSBzZXRhciBvIHZhbG9yIHZpbmRvIGRvIHdyaXRlVmFsdWUgZG8gY29tcG9uZW50ZSBwcmluY2lwYWwuXG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZVZhbHVlV2l0aE1vZGVsVmFsdWUoKSk7XG4gIH1cblxuICBleGVjdXRlQ29tbWFuZChjb21tYW5kOiAoc3RyaW5nIHwgeyBjb21tYW5kOiBhbnksIHZhbHVlOiBzdHJpbmcgfCBhbnkgfSkpIHtcbiAgICB0aGlzLmJvZHlFbGVtZW50Lm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcblxuICAgIGlmICh0eXBlb2YgKGNvbW1hbmQpID09PSAnb2JqZWN0Jykge1xuXG4gICAgICBpZiAoY29tbWFuZC5jb21tYW5kID09PSAnSW5zZXJ0SFRNTCcpIHtcbiAgICAgICAgY29uc3QgeyBjb21tYW5kOiBsaW5rQ29tbWFuZCwgdmFsdWUgOiB7IHVybExpbmsgfSwgdmFsdWUgOiB7IHVybExpbmtUZXh0fSB9ID0gY29tbWFuZDtcblxuICAgICAgICB0aGlzLmhhbmRsZUNvbW1hbmRMaW5rKGxpbmtDb21tYW5kLCB1cmxMaW5rLCB1cmxMaW5rVGV4dCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZChjb21tYW5kLmNvbW1hbmQsIGZhbHNlLCBjb21tYW5kLnZhbHVlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoY29tbWFuZCwgZmFsc2UsIG51bGwpO1xuICAgIH1cblxuICAgIHRoaXMudXBkYXRlTW9kZWwoKTtcbiAgICB0aGlzLnZhbHVlLmVtaXQodGhpcy5tb2RlbFZhbHVlKTtcbiAgfVxuXG4gIG9uQmx1cigpIHtcbiAgICBpZiAodGhpcy5tb2RlbFZhbHVlICE9PSB0aGlzLnZhbHVlQmVmb3JlQ2hhbmdlKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0Q2hhbmdlKTtcbiAgICAgIHRoaXMudGltZW91dENoYW5nZSA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KHRoaXMubW9kZWxWYWx1ZSk7XG4gICAgICB9LCAyMDApO1xuICAgIH1cbiAgfVxuXG4gIGZvY3VzKCk6IHZvaWQge1xuICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICB9XG5cbiAgb25DbGljaygpIHtcbiAgICB0aGlzLmVtaXRTZWxlY3Rpb25Db21tYW5kcygpO1xuICB9XG5cbiAgb25Gb2N1cygpIHtcbiAgICB0aGlzLnZhbHVlQmVmb3JlQ2hhbmdlID0gdGhpcy5tb2RlbFZhbHVlO1xuICB9XG5cbiAgb25LZXlEb3duKGV2ZW50KSB7XG4gICAgY29uc3Qga2V5TCA9IGV2ZW50LmtleUNvZGUgPT09IFBvS2V5Q29kZUVudW0ua2V5TDtcblxuICAgIGlmIChrZXlMICYmIGV2ZW50LmN0cmxLZXkgfHwga2V5TCAmJiBldmVudC5tZXRhS2V5KSB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgdGhpcy5zaG9ydGN1dENvbW1hbmQuZW1pdCgpO1xuICAgIH1cbiAgfVxuXG4gIG9uS2V5VXAoKSB7XG4gICAgLy8gVHJhdGFtZW50byBuZWNlc3PDoXJpbyBwYXJhIGVsaW1pbmFyIGEgdGFnIDxicj4gY3JpYWRhIG5vIGZpcmVmb3ggcXVhbmRvIG8gYm9keSBmb3IgbGltcG8uXG4gICAgY29uc3QgYm9keUVsZW1lbnQgPSB0aGlzLmJvZHlFbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICBpZiAoIWJvZHlFbGVtZW50LmlubmVyVGV4dC50cmltKCkgJiYgYm9keUVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgJiYgYm9keUVsZW1lbnQucXVlcnlTZWxlY3RvcignYnInKSkge1xuICAgICAgYm9keUVsZW1lbnQucXVlcnlTZWxlY3RvcignYnInKS5yZW1vdmUoKTtcbiAgICB9XG5cbiAgICB0aGlzLnVwZGF0ZU1vZGVsKCk7XG4gICAgdGhpcy5lbWl0U2VsZWN0aW9uQ29tbWFuZHMoKTtcbiAgfVxuXG4gIHVwZGF0ZSgpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBkYXRlTW9kZWwoKSk7XG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLm9uS2V5VXAoKSk7XG4gIH1cblxuICBwcml2YXRlIGN1cnNvclBvc2l0aW9uZWRJbkFMaW5rKCkge1xuICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTtcblxuICAgIHJldHVybiBsaW5rLmZvY3VzTm9kZS5wYXJlbnRFbGVtZW50LnRhZ05hbWUgPT09ICdBJztcbiAgfVxuXG4gIHByaXZhdGUgZW1pdFNlbGVjdGlvbkNvbW1hbmRzKCkge1xuICAgIGNvbnN0IGNvbW1hbmRzID0gcG9SaWNoVGV4dEJvZHlDb21tYW5kcy5maWx0ZXIoY29tbWFuZCA9PiBkb2N1bWVudC5xdWVyeUNvbW1hbmRTdGF0ZShjb21tYW5kKSk7XG4gICAgY29uc3QgcmdiQ29sb3IgPSBkb2N1bWVudC5xdWVyeUNvbW1hbmRWYWx1ZSgnRm9yZUNvbG9yJyk7XG4gICAgY29uc3QgaGV4Q29sb3IgPSB0aGlzLnJnYlRvSGV4KHJnYkNvbG9yKTtcblxuICAgIGlmICh0aGlzLmN1cnNvclBvc2l0aW9uZWRJbkFMaW5rKCkpIHtcbiAgICAgIGNvbW1hbmRzLnB1c2goJ0NyZWF0ZWxpbmsnKTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbW1hbmRzLmVtaXQoe2NvbW1hbmRzLCBoZXhDb2xvcn0pO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVDb21tYW5kTGluayhsaW5rQ29tbWFuZDogc3RyaW5nLCB1cmxMaW5rOiBzdHJpbmcsIHVybExpbmtUZXh0OiBzdHJpbmcpIHtcbiAgICBpZiAoaXNJRSgpKSB7XG4gICAgICB0aGlzLmluc2VydEh0bWxMaW5rRWxlbWVudCh1cmxMaW5rLCB1cmxMaW5rVGV4dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIG5lY2Vzc8OhcmlvICcmbmJzcDsnIG5vIGZpbSBwb2lzIG8gRmlyZWZveCBtYW50w6ltIG8gY3Vyc29yIGRlbnRybyBkYSB0YWc7XG4gICAgICBjb25zdCBsaW5rVmFsdWUgPSBgPGEgY2xhc3M9XCJwby1yaWNoLXRleHQtbGlua1wiIGhyZWY9XCIke3VybExpbmt9XCIgdGFyZ2V0PVwiX2JsYW5rXCI+JHt1cmxMaW5rVGV4dCB8fCB1cmxMaW5rfTwvYT5gO1xuXG4gICAgICBkb2N1bWVudC5leGVjQ29tbWFuZChsaW5rQ29tbWFuZCwgZmFsc2UsIGxpbmtWYWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgLy8gdHJhdGFtZW50byBlc3BlY8OtZmljbyBwYXJhIElFIHBvaXMgbsOjbyBzdXBvcnRhIG8gY29tYW5kbyAnaW5zZXJ0SFRNTCcuXG4gIHByaXZhdGUgaW5zZXJ0SHRtbExpbmtFbGVtZW50KHVybExpbms6IHN0cmluZywgdXJsTGlua1RleHQ6IHN0cmluZykge1xuICAgIGNvbnN0wqBzZWxlY3Rpb27CoD3CoGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xuICAgIGNvbnN0IHNlbGVjdGlvblJhbmdlID0gc2VsZWN0aW9uLmdldFJhbmdlQXQoMCk7XG4gICAgY29uc3QgZWxlbWVudExpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XG4gICAgY29uc3QgZWxlbWVudGxpbmtUZXh0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodXJsTGlua1RleHQpO1xuXG4gICAgZWxlbWVudExpbmsuYXBwZW5kQ2hpbGQoZWxlbWVudGxpbmtUZXh0KTtcbiAgICBlbGVtZW50TGluay5ocmVmID0gdXJsTGluaztcbiAgICBlbGVtZW50TGluay5zZXRBdHRyaWJ1dGUoJ3RhcmdldCcsICdfYmxhbmsnKTtcbiAgICBlbGVtZW50TGluay5jbGFzc0xpc3QuYWRkKCdwby1yaWNoLXRleHQtbGluaycpO1xuXG4gICAgc2VsZWN0aW9uUmFuZ2UuZGVsZXRlQ29udGVudHMoKTtcbiAgICBzZWxlY3Rpb25SYW5nZS5pbnNlcnROb2RlKGVsZW1lbnRMaW5rKTtcbiAgfVxuXG4gIHByaXZhdGUgcmdiVG9IZXgocmdiKSB7XG4gICAgLy8gVHJhdGFtZW50byBuZWNlc3PDoXJpbyBwYXJhIGNvbnZlcnRlciBvIGPDs2RpZ28gcmdiIHBhcmEgaGV4YWRlY2ltYWwuXG4gICAgY29uc3Qgc2VwID0gcmdiLmluZGV4T2YoJywnKSA+IC0xID8gJywnIDogJyAnO1xuICAgIHJnYiA9IHJnYi5zdWJzdHIoNCkuc3BsaXQoJyknKVswXS5zcGxpdChzZXApO1xuXG4gICAgbGV0IHIgPSAoK3JnYlswXSkudG9TdHJpbmcoMTYpO1xuICAgIGxldCBnID0gKCtyZ2JbMV0pLnRvU3RyaW5nKDE2KTtcbiAgICBsZXQgYiA9ICgrcmdiWzJdKS50b1N0cmluZygxNik7XG5cbiAgICBpZiAoci5sZW5ndGggPT09IDEpIHtcbiAgICAgIHIgPSAnMCcgKyByO1xuICAgIH1cbiAgICBpZiAoZy5sZW5ndGggPT09IDEpIHtcbiAgICAgIGcgPSAnMCcgKyBnO1xuICAgIH1cbiAgICBpZiAoYi5sZW5ndGggPT09IDEpIHtcbiAgICAgIGIgPSAnMCcgKyBiO1xuICAgIH1cblxuICAgIHJldHVybiAnIycgKyByICsgZyArIGI7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZU1vZGVsKCkge1xuICAgIHRoaXMubW9kZWxWYWx1ZSA9IHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5pbm5lckhUTUw7XG5cbiAgICB0aGlzLnZhbHVlLmVtaXQodGhpcy5tb2RlbFZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlVmFsdWVXaXRoTW9kZWxWYWx1ZSgpIHtcbiAgICBpZiAodGhpcy5tb2RlbFZhbHVlKSB7XG4gICAgICB0aGlzLmJvZHlFbGVtZW50Lm5hdGl2ZUVsZW1lbnQuaW5zZXJ0QWRqYWNlbnRIVE1MKCdhZnRlcmJlZ2luJywgdGhpcy5tb2RlbFZhbHVlKTtcbiAgICB9XG4gIH1cblxufVxuIl19