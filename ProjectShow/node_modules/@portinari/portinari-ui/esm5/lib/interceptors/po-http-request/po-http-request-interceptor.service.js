/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { PoComponentInjectorService } from '../../services/po-component-injector/po-component-injector.service';
import { PoLoadingOverlayComponent } from '../../components/po-loading/po-loading-overlay/po-loading-overlay.component';
import { PoHttpRequesControltService } from './po-http-request-control-service';
import * as i0 from "@angular/core";
import * as i1 from "./po-http-request-control-service";
import * as i2 from "../../services/po-component-injector/po-component-injector.service";
/** @type {?} */
var noCountPendingRequests = 'X-Portinari-No-Count-Pending-Requests';
/** @type {?} */
var screenLock = 'X-Portinari-Screen-Lock';
/**
 * \@description
 *
 * O serviço Portinari Http Request Interceptor realiza a contabilização de requisições pendentes na aplicação.
 *
 * Existe a possibilidade de não efetuar a contabilização das requisições pendentes, utilizando o parâmetro
 * `X-Portinari-No-Count-Pending-Requests`. Para isso deve ser informado no cabeçalho da requisição com o valor `'true'`,
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Portinari-No-Count-Pending-Requests': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * Para obter a quantidade de requisições pendentes, deve inscrever-se no método `getCountPendingRequests` do
 * serviço `PoHttpRequestInterceptorService`, com isso, ao realizar requisições utilizando `HttpClient`,
 * será retornado a quantidade de requisições pendentes.
 *
 * Também existe a possibildade de travar a tela e mostrar uma imagem de _loading_ durante o processamento de uma requisição
 * deve-se passar o parâmetro `X-Portinari-Screen-Lock` no cabeçalho da requisição com valor `'true'`.
 *
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Portinari-Screen-Lock': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * > Após a validação no interceptor, o parâmetro será removido do cabeçalho da requisição.
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-request-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 *
 * Segue abaixo um exemplo de uso:
 *
 * ```
 * import { HttpClient } from '\@angular/common/http';
 *
 * ...
 *
 * \@Injectable()
 * export class CustomersService {
 *
 *  headers = { 'X-Portinari-No-Count-Pending-Requests': true, 'X-Portinari-Screen-Lock': 'true' }
 *  pendingRequests: number = 0;
 *  subscription: Subscription;
 *
 *  constructor(
 *    private http: HttpClient,
 *    private httpRequestInterceptor: PoHttpRequestInterceptorService) { }
 *
 *  ngOnDestroy(): void {
 *    this.subscription.unsubscribe();
 *  }
 *
 *  ngOnInit(): void {
 *    this.subscription = this.httpRequestInterceptor.getCountPendingRequests().subscribe(data => {
 *      this.pendingRequests = data;
 *    });
 *  }
 *
 *  getCustomers() {
 *    return this.http.get(`/customers/1`, { headers: headers });
 *  }
 *
 *  ...
 *
 * }
 * ```
 *
 * \@example
 * <example name='po-http-request-interceptor-labs' title='Portinari Http Request Interceptor Labs'>
 *  <file name='sample-po-http-request-interceptor-labs.component.ts'> </file>
 *  <file name='sample-po-http-request-interceptor-labs.component.html'> </file>
 * </example>
 */
var PoHttpRequestInterceptorService = /** @class */ (function () {
    function PoHttpRequestInterceptorService(controlHttpRequest, poComponentInjector) {
        this.controlHttpRequest = controlHttpRequest;
        this.poComponentInjector = poComponentInjector;
        this.loadingOverlayComponent = undefined;
        this.pendingRequests = 0;
        this.overlayRequests = 0;
    }
    /**
     * @param {?} request
     * @param {?} next
     * @return {?}
     */
    PoHttpRequestInterceptorService.prototype.intercept = /**
     * @param {?} request
     * @param {?} next
     * @return {?}
     */
    function (request, next) {
        var _this = this;
        /** @type {?} */
        var requestClone = request.clone();
        request = this.requestCloneWithoutHeaderParam([noCountPendingRequests, screenLock], request);
        this.setCountPendingRequests(true, requestClone);
        this.setCountOverlayRequests(true, requestClone);
        return next.handle(request).pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        function (response) {
            if (response instanceof HttpResponse) {
                _this.setCountPendingRequests(false, requestClone);
                _this.setCountOverlayRequests(false, requestClone);
            }
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            _this.setCountPendingRequests(false, requestClone);
            _this.setCountOverlayRequests(false, requestClone);
            return throwError(error);
        })));
    };
    /**
     * @return {?}
     */
    PoHttpRequestInterceptorService.prototype.getCountPendingRequests = /**
     * @return {?}
     */
    function () {
        return this.controlHttpRequest.getControlHttpRequest();
    };
    /**
     * @private
     * @return {?}
     */
    PoHttpRequestInterceptorService.prototype.buildLoading = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.loadingOverlayComponent) {
            this.loadingOverlayComponent = this.poComponentInjector.createComponentInApplication(PoLoadingOverlayComponent);
            this.loadingOverlayComponent.instance.screenLock = true;
            this.loadingOverlayComponent.instance.changeDetector.detectChanges();
        }
    };
    /**
     * @private
     * @return {?}
     */
    PoHttpRequestInterceptorService.prototype.destroyLoading = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.loadingOverlayComponent) {
            this.poComponentInjector.destroyComponentInApplication(this.loadingOverlayComponent);
            this.loadingOverlayComponent = undefined;
        }
    };
    /**
     * @private
     * @param {?} headersParams
     * @param {?} request
     * @return {?}
     */
    PoHttpRequestInterceptorService.prototype.requestCloneWithoutHeaderParam = /**
     * @private
     * @param {?} headersParams
     * @param {?} request
     * @return {?}
     */
    function (headersParams, request) {
        /** @type {?} */
        var isRequestClone = false;
        headersParams.forEach((/**
         * @param {?} headerParam
         * @return {?}
         */
        function (headerParam) {
            if (request.headers.has(headerParam)) {
                request.headers.delete(headerParam);
                isRequestClone = true;
            }
        }));
        return isRequestClone ? request.clone({ headers: request.headers }) : request;
    };
    /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    PoHttpRequestInterceptorService.prototype.setCountPendingRequests = /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    function (isIncrement, request) {
        /** @type {?} */
        var hasCountPendingRequestHeaderParam = request.headers.has(noCountPendingRequests);
        /** @type {?} */
        var headerParam = request.headers.get(noCountPendingRequests);
        if (hasCountPendingRequestHeaderParam && (headerParam.toString().toLowerCase() === 'true')) {
            return;
        }
        this.pendingRequests += isIncrement ? 1 : -1;
        this.controlHttpRequest.send(this.pendingRequests);
    };
    /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    PoHttpRequestInterceptorService.prototype.setCountOverlayRequests = /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    function (isIncrement, request) {
        /** @type {?} */
        var hasOverlayRequestHeaderParam = request.headers.has(screenLock);
        if (hasOverlayRequestHeaderParam) {
            /** @type {?} */
            var headerParam = request.headers.get(screenLock);
            if (headerParam.toString().toLowerCase() === 'false') {
                return;
            }
            this.overlayRequests += isIncrement ? 1 : -1;
            this.overlayRequests > 0 ? this.buildLoading() : this.destroyLoading();
        }
    };
    PoHttpRequestInterceptorService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    PoHttpRequestInterceptorService.ctorParameters = function () { return [
        { type: PoHttpRequesControltService },
        { type: PoComponentInjectorService }
    ]; };
    /** @nocollapse */ PoHttpRequestInterceptorService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function PoHttpRequestInterceptorService_Factory() { return new PoHttpRequestInterceptorService(i0.ɵɵinject(i1.PoHttpRequesControltService), i0.ɵɵinject(i2.PoComponentInjectorService)); }, token: PoHttpRequestInterceptorService, providedIn: "root" });
    return PoHttpRequestInterceptorService;
}());
export { PoHttpRequestInterceptorService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    PoHttpRequestInterceptorService.prototype.loadingOverlayComponent;
    /**
     * @type {?}
     * @private
     */
    PoHttpRequestInterceptorService.prototype.pendingRequests;
    /**
     * @type {?}
     * @private
     */
    PoHttpRequestInterceptorService.prototype.overlayRequests;
    /**
     * @type {?}
     * @private
     */
    PoHttpRequestInterceptorService.prototype.controlHttpRequest;
    /**
     * @type {?}
     * @private
     */
    PoHttpRequestInterceptorService.prototype.poComponentInjector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS11aS8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvcG8taHR0cC1yZXF1ZXN0L3BvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RCxPQUFPLEVBQXdELFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTFHLE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxvRUFBb0UsQ0FBQztBQUNoSCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw2RUFBNkUsQ0FBQztBQUV4SCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQzs7Ozs7SUFFMUUsc0JBQXNCLEdBQUcsdUNBQXVDOztJQUNoRSxVQUFVLEdBQUcseUJBQXlCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFxRjVDO0lBVUUseUNBQ1Usa0JBQStDLEVBQy9DLG1CQUErQztRQUQvQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQTZCO1FBQy9DLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBNEI7UUFQakQsNEJBQXVCLEdBQTRDLFNBQVMsQ0FBQztRQUU3RSxvQkFBZSxHQUFXLENBQUMsQ0FBQztRQUM1QixvQkFBZSxHQUFXLENBQUMsQ0FBQztJQUkwQixDQUFDOzs7Ozs7SUFFL0QsbURBQVM7Ozs7O0lBQVQsVUFBVSxPQUF5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b0M7Ozs7O0lBR2xDLDZEQUF1RDs7Ozs7SUFDdkQsOERBQXVEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50UmVmLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwRXZlbnQsIEh0dHBIYW5kbGVyLCBIdHRwSW50ZXJjZXB0b3IsIEh0dHBSZXF1ZXN0LCBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgUG9Db21wb25lbnRJbmplY3RvclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1jb21wb25lbnQtaW5qZWN0b3IvcG8tY29tcG9uZW50LWluamVjdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9Mb2FkaW5nT3ZlcmxheUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvcG8tbG9hZGluZy9wby1sb2FkaW5nLW92ZXJsYXkvcG8tbG9hZGluZy1vdmVybGF5LmNvbXBvbmVudCc7XG5cbmltcG9ydCB7IFBvSHR0cFJlcXVlc0NvbnRyb2x0U2VydmljZSB9IGZyb20gJy4vcG8taHR0cC1yZXF1ZXN0LWNvbnRyb2wtc2VydmljZSc7XG5cbmNvbnN0IG5vQ291bnRQZW5kaW5nUmVxdWVzdHMgPSAnWC1Qb3J0aW5hcmktTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc7XG5jb25zdCBzY3JlZW5Mb2NrID0gJ1gtUG9ydGluYXJpLVNjcmVlbi1Mb2NrJztcblxuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqXG4gKiBPIHNlcnZpw6dvIFBvcnRpbmFyaSBIdHRwIFJlcXVlc3QgSW50ZXJjZXB0b3IgcmVhbGl6YSBhIGNvbnRhYmlsaXphw6fDo28gZGUgcmVxdWlzacOnw7VlcyBwZW5kZW50ZXMgbmEgYXBsaWNhw6fDo28uXG4gKlxuICogRXhpc3RlIGEgcG9zc2liaWxpZGFkZSBkZSBuw6NvIGVmZXR1YXIgYSBjb250YWJpbGl6YcOnw6NvIGRhcyByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcywgdXRpbGl6YW5kbyBvIHBhcsOibWV0cm9cbiAqIGBYLVBvcnRpbmFyaS1Oby1Db3VudC1QZW5kaW5nLVJlcXVlc3RzYC4gUGFyYSBpc3NvIGRldmUgc2VyIGluZm9ybWFkbyBubyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8OjbyBjb20gbyB2YWxvciBgJ3RydWUnYCxcbiAqIHBvciBleGVtcGxvOlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUG9ydGluYXJpLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHMnOiAndHJ1ZScgfTtcbiAqXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogLi4uXG4gKlxuICogYGBgXG4gKiBQYXJhIG9idGVyIGEgcXVhbnRpZGFkZSBkZSByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcywgZGV2ZSBpbnNjcmV2ZXItc2Ugbm8gbcOpdG9kbyBgZ2V0Q291bnRQZW5kaW5nUmVxdWVzdHNgIGRvXG4gKiBzZXJ2acOnbyBgUG9IdHRwUmVxdWVzdEludGVyY2VwdG9yU2VydmljZWAsIGNvbSBpc3NvLCBhbyByZWFsaXphciByZXF1aXNpw6fDtWVzIHV0aWxpemFuZG8gYEh0dHBDbGllbnRgLFxuICogc2Vyw6EgcmV0b3JuYWRvIGEgcXVhbnRpZGFkZSBkZSByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcy5cbiAqXG4gKiBUYW1iw6ltIGV4aXN0ZSBhIHBvc3NpYmlsZGFkZSBkZSB0cmF2YXIgYSB0ZWxhIGUgbW9zdHJhciB1bWEgaW1hZ2VtIGRlIF9sb2FkaW5nXyBkdXJhbnRlIG8gcHJvY2Vzc2FtZW50byBkZSB1bWEgcmVxdWlzacOnw6NvXG4gKiBkZXZlLXNlIHBhc3NhciBvIHBhcsOibWV0cm8gYFgtUG9ydGluYXJpLVNjcmVlbi1Mb2NrYCBubyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8OjbyBjb20gdmFsb3IgYCd0cnVlJ2AuXG4gKlxuICogcG9yIGV4ZW1wbG86XG4gKlxuICogYGBgXG4gKiAuLi5cbiAqICBjb25zdCBoZWFkZXJzID0geyAnWC1Qb3J0aW5hcmktU2NyZWVuLUxvY2snOiAndHJ1ZScgfTtcbiAqXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogLi4uXG4gKlxuICogYGBgXG4gKiA+IEFww7NzIGEgdmFsaWRhw6fDo28gbm8gaW50ZXJjZXB0b3IsIG8gcGFyw6JtZXRybyBzZXLDoSByZW1vdmlkbyBkbyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8Ojby5cbiAqXG4gKiBBbyBpbXBvcnRhciBvIG3Ds2R1bG8gYFBvTW9kdWxlYCBuYSBhcGxpY2HDp8OjbywgbyBgcG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yYCDDqSBhdXRvbWF0aWNhbWVudGUgY29uZmlndXJhZG8gc2VtIGEgbmVjZXNzaWRhZGVcbiAqIGRlIHF1YWxxdWVyIGNvbmZpZ3VyYcOnw6NvIGV4dHJhLlxuICpcbiAqXG4gKiBTZWd1ZSBhYmFpeG8gdW0gZXhlbXBsbyBkZSB1c286XG4gKlxuICogYGBgXG4gKiBpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuICpcbiAqIC4uLlxuICpcbiAqIEBJbmplY3RhYmxlKClcbiAqIGV4cG9ydCBjbGFzcyBDdXN0b21lcnNTZXJ2aWNlIHtcbiAqXG4gKiAgaGVhZGVycyA9IHsgJ1gtUG9ydGluYXJpLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHMnOiB0cnVlLCAnWC1Qb3J0aW5hcmktU2NyZWVuLUxvY2snOiAndHJ1ZScgfVxuICogIHBlbmRpbmdSZXF1ZXN0czogbnVtYmVyID0gMDtcbiAqICBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAqXG4gKiAgY29uc3RydWN0b3IoXG4gKiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXG4gKiAgICBwcml2YXRlIGh0dHBSZXF1ZXN0SW50ZXJjZXB0b3I6IFBvSHR0cFJlcXVlc3RJbnRlcmNlcHRvclNlcnZpY2UpIHsgfVxuICpcbiAqICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAqICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gKiAgfVxuICpcbiAqICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAqICAgIHRoaXMuc3Vic2NyaXB0aW9uID0gdGhpcy5odHRwUmVxdWVzdEludGVyY2VwdG9yLmdldENvdW50UGVuZGluZ1JlcXVlc3RzKCkuc3Vic2NyaWJlKGRhdGEgPT4ge1xuICogICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cyA9IGRhdGE7XG4gKiAgICB9KTtcbiAqICB9XG4gKlxuICogIGdldEN1c3RvbWVycygpIHtcbiAqICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAgfVxuICpcbiAqICAuLi5cbiAqXG4gKiB9XG4gKiBgYGBcbiAqXG4gKiBAZXhhbXBsZVxuICogPGV4YW1wbGUgbmFtZT0ncG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLWxhYnMnIHRpdGxlPSdQb3J0aW5hcmkgSHR0cCBSZXF1ZXN0IEludGVyY2VwdG9yIExhYnMnPlxuICogIDxmaWxlIG5hbWU9J3NhbXBsZS1wby1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3ItbGFicy5jb21wb25lbnQudHMnPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT0nc2FtcGxlLXBvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci1sYWJzLmNvbXBvbmVudC5odG1sJz4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBQb0h0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcblxuICBwcml2YXRlIGxvYWRpbmdPdmVybGF5Q29tcG9uZW50OiBDb21wb25lbnRSZWY8UG9Mb2FkaW5nT3ZlcmxheUNvbXBvbmVudD4gPSB1bmRlZmluZWQ7XG5cbiAgcHJpdmF0ZSBwZW5kaW5nUmVxdWVzdHM6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgb3ZlcmxheVJlcXVlc3RzOiBudW1iZXIgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY29udHJvbEh0dHBSZXF1ZXN0OiBQb0h0dHBSZXF1ZXNDb250cm9sdFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBwb0NvbXBvbmVudEluamVjdG9yOiBQb0NvbXBvbmVudEluamVjdG9yU2VydmljZSkgeyAgfVxuXG4gIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcikge1xuXG4gICAgY29uc3QgcmVxdWVzdENsb25lID0gcmVxdWVzdC5jbG9uZSgpO1xuXG4gICAgcmVxdWVzdCA9IHRoaXMucmVxdWVzdENsb25lV2l0aG91dEhlYWRlclBhcmFtKFtub0NvdW50UGVuZGluZ1JlcXVlc3RzLCBzY3JlZW5Mb2NrXSwgcmVxdWVzdCk7XG5cbiAgICB0aGlzLnNldENvdW50UGVuZGluZ1JlcXVlc3RzKHRydWUsIHJlcXVlc3RDbG9uZSk7XG4gICAgdGhpcy5zZXRDb3VudE92ZXJsYXlSZXF1ZXN0cyh0cnVlLCByZXF1ZXN0Q2xvbmUpO1xuXG4gICAgcmV0dXJuIG5leHQuaGFuZGxlKHJlcXVlc3QpLnBpcGUoXG4gICAgICB0YXAoKHJlc3BvbnNlOiBIdHRwRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICBpZiAocmVzcG9uc2UgaW5zdGFuY2VvZiBIdHRwUmVzcG9uc2UpIHtcbiAgICAgICAgICB0aGlzLnNldENvdW50UGVuZGluZ1JlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgICAgIHRoaXMuc2V0Q291bnRPdmVybGF5UmVxdWVzdHMoZmFsc2UsIHJlcXVlc3RDbG9uZSk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgIHRoaXMuc2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoZmFsc2UsIHJlcXVlc3RDbG9uZSk7XG4gICAgICAgIHRoaXMuc2V0Q291bnRPdmVybGF5UmVxdWVzdHMoZmFsc2UsIHJlcXVlc3RDbG9uZSk7XG5cbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgZ2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5jb250cm9sSHR0cFJlcXVlc3QuZ2V0Q29udHJvbEh0dHBSZXF1ZXN0KCk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkTG9hZGluZygpIHtcbiAgICBpZiAoIXRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQpIHtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQgPSB0aGlzLnBvQ29tcG9uZW50SW5qZWN0b3IuY3JlYXRlQ29tcG9uZW50SW5BcHBsaWNhdGlvbihQb0xvYWRpbmdPdmVybGF5Q29tcG9uZW50KTtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQuaW5zdGFuY2Uuc2NyZWVuTG9jayA9IHRydWU7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50Lmluc3RhbmNlLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRlc3Ryb3lMb2FkaW5nKCkge1xuICAgIGlmICh0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50KSB7XG4gICAgICB0aGlzLnBvQ29tcG9uZW50SW5qZWN0b3IuZGVzdHJveUNvbXBvbmVudEluQXBwbGljYXRpb24odGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCk7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVxdWVzdENsb25lV2l0aG91dEhlYWRlclBhcmFtKGhlYWRlcnNQYXJhbXM6IEFycmF5PHN0cmluZz4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBIdHRwUmVxdWVzdDxhbnk+IHtcbiAgICBsZXQgaXNSZXF1ZXN0Q2xvbmUgPSBmYWxzZTtcblxuICAgIGhlYWRlcnNQYXJhbXMuZm9yRWFjaChoZWFkZXJQYXJhbSA9PiB7XG4gICAgICBpZiAocmVxdWVzdC5oZWFkZXJzLmhhcyhoZWFkZXJQYXJhbSkpIHtcbiAgICAgICAgcmVxdWVzdC5oZWFkZXJzLmRlbGV0ZShoZWFkZXJQYXJhbSk7XG4gICAgICAgIGlzUmVxdWVzdENsb25lID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGlzUmVxdWVzdENsb25lID8gcmVxdWVzdC5jbG9uZSh7aGVhZGVyczogcmVxdWVzdC5oZWFkZXJzfSkgOiByZXF1ZXN0O1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyhpc0luY3JlbWVudDogYm9vbGVhbiwgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xuXG4gICAgY29uc3QgaGFzQ291bnRQZW5kaW5nUmVxdWVzdEhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmhhcyhub0NvdW50UGVuZGluZ1JlcXVlc3RzKTtcbiAgICBjb25zdCBoZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5nZXQobm9Db3VudFBlbmRpbmdSZXF1ZXN0cyk7XG5cbiAgICBpZiAoaGFzQ291bnRQZW5kaW5nUmVxdWVzdEhlYWRlclBhcmFtICYmIChoZWFkZXJQYXJhbS50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkgPT09ICd0cnVlJyApICkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzICs9IGlzSW5jcmVtZW50ID8gMSA6IC0xO1xuICAgIHRoaXMuY29udHJvbEh0dHBSZXF1ZXN0LnNlbmQodGhpcy5wZW5kaW5nUmVxdWVzdHMpO1xuXG4gIH1cblxuICBwcml2YXRlIHNldENvdW50T3ZlcmxheVJlcXVlc3RzKGlzSW5jcmVtZW50OiBib29sZWFuLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgaGFzT3ZlcmxheVJlcXVlc3RIZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5oYXMoc2NyZWVuTG9jayk7XG5cbiAgICBpZiAoaGFzT3ZlcmxheVJlcXVlc3RIZWFkZXJQYXJhbSkge1xuICAgICAgY29uc3QgaGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KHNjcmVlbkxvY2spO1xuXG4gICAgICBpZiAoaGVhZGVyUGFyYW0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpID09PSAnZmFsc2UnKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5vdmVybGF5UmVxdWVzdHMgKz0gaXNJbmNyZW1lbnQgPyAxIDogLTE7XG4gICAgICB0aGlzLm92ZXJsYXlSZXF1ZXN0cyA+IDAgPyB0aGlzLmJ1aWxkTG9hZGluZygpIDogdGhpcy5kZXN0cm95TG9hZGluZygpO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=