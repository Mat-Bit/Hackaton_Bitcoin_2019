/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { PoI18nPipe } from '../../../../services/po-i18n/po-i18n.pipe';
import { PoNotificationService } from '../../../../services/po-notification/po-notification.service';
export class PoUploadDragDropDirective {
    /**
     * @param {?} i18nPipe
     * @param {?} notification
     */
    constructor(i18nPipe, notification) {
        this.i18nPipe = i18nPipe;
        this.notification = notification;
        this.dragLeave = new EventEmitter();
        this.dragOver = new EventEmitter();
        this.fileChange = new EventEmitter();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        this.timeout = setTimeout((/**
         * @return {?}
         */
        () => this.dragLeave.emit()), 30);
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        clearTimeout(this.timeout);
        if (!this.disabled) {
            this.dragOver.emit();
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onDrop(event) {
        event.preventDefault();
        event.stopPropagation();
        this.getFilesFromDataTransferItems(event);
        this.dragLeave.emit();
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    getFilesFromDataTransferItems(event) {
        if (!this.disabled) {
            this.invalidFileType = 0;
            if (this.directoryCompatible) {
                this.getOnlyDirectories(event.dataTransfer.items).then((/**
                 * @return {?}
                 */
                () => {
                    this.sendFiles(event, this.files);
                }));
            }
            else {
                /** @type {?} */
                const files = this.getOnlyFiles(event.dataTransfer.files);
                this.sendFiles(event, files);
            }
        }
    }
    // analisa as entradas recursivamente
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    getFilesFromEntry(entry) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (entry.isFile) {
                /** @type {?} */
                const file = yield this.readFile(entry);
                return [file];
            }
            else if (entry.isDirectory) {
                return yield this.readDirectory(entry);
            }
        });
    }
    /**
     * @private
     * @param {?} dataTransferItems
     * @return {?}
     */
    getOnlyDirectories(dataTransferItems) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const entries = [];
            // lista todas as entradas antes de analisá-las
            for (const item of dataTransferItems) {
                entries.push(item.webkitGetAsEntry());
            }
            this.files = [];
            for (const entry of entries) {
                if (entry.isFile) {
                    this.invalidFileType++;
                }
                else {
                    /** @type {?} */
                    const newFiles = yield this.getFilesFromEntry(entry);
                    this.files = this.files.concat(newFiles);
                }
            }
        });
    }
    // return only files. If it is a directory, invalidFileType counts.
    /**
     * @private
     * @param {?} fileList
     * @return {?}
     */
    getOnlyFiles(fileList) {
        return Array.from(fileList).reduce((/**
         * @param {?} newFiles
         * @param {?} file
         * @return {?}
         */
        (newFiles, file) => {
            if (file.type) {
                return newFiles.concat(file);
            }
            else {
                this.invalidFileType++;
            }
            return newFiles;
        }), []);
    }
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    readFile(entry) {
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        resolve => {
            entry.file((/**
             * @param {?} file
             * @return {?}
             */
            file => {
                resolve(file);
            }));
        }));
    }
    /**
     * @private
     * @param {?} entry
     * @return {?}
     */
    readDirectory(entry) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const dirReader = entry.createReader();
            /** @type {?} */
            let files = [];
            /** @type {?} */
            let newFiles;
            newFiles = yield this.readDirectoryEntries(dirReader);
            files = files.concat(newFiles);
            return files;
        });
    }
    /**
     * @private
     * @param {?} dirReader
     * @return {?}
     */
    readDirectoryEntries(dirReader) {
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        resolve => {
            dirReader.readEntries((/**
             * @param {?} entries
             * @return {?}
             */
            (entries) => tslib_1.__awaiter(this, void 0, void 0, function* () {
                /** @type {?} */
                let files = [];
                for (const entry of entries) {
                    /** @type {?} */
                    const itemFiles = yield this.getFilesFromEntry(entry);
                    files = files.concat(itemFiles);
                }
                resolve(files);
            })));
        }));
    }
    /**
     * @private
     * @param {?} invalidFiles
     * @return {?}
     */
    sendFeedback(invalidFiles) {
        if (invalidFiles) {
            this.setPipeArguments('invalidFileType', invalidFiles);
        }
    }
    /**
     * @private
     * @param {?} event
     * @param {?} files
     * @return {?}
     */
    sendFiles(event, files) {
        if (this.areaElement.contains(event.target)) {
            if (files.length > 0) {
                this.fileChange.emit(files);
            }
            this.sendFeedback(this.invalidFileType);
        }
        else {
            /** @type {?} */
            const invalidDropAreaArg = this.directoryCompatible ? this.literals.folders : this.literals.files;
            this.setPipeArguments('invalidDropArea', invalidDropAreaArg);
        }
    }
    // método responsável por setar os argumentos do i18nPipe.
    /**
     * @private
     * @param {?} literalAttributes
     * @param {?=} args
     * @return {?}
     */
    setPipeArguments(literalAttributes, args) {
        /** @type {?} */
        const pipeArguments = this.i18nPipe.transform(this.literals[literalAttributes], args);
        this.notification.information(pipeArguments);
    }
}
PoUploadDragDropDirective.decorators = [
    { type: Directive, args: [{
                selector: '[p-upload-drag-drop]',
                providers: [PoI18nPipe]
            },] }
];
/** @nocollapse */
PoUploadDragDropDirective.ctorParameters = () => [
    { type: PoI18nPipe },
    { type: PoNotificationService }
];
PoUploadDragDropDirective.propDecorators = {
    areaElement: [{ type: Input, args: ['p-area-element',] }],
    directoryCompatible: [{ type: Input, args: ['p-directory-compatible',] }],
    disabled: [{ type: Input, args: ['p-disabled',] }],
    literals: [{ type: Input, args: ['p-literals',] }],
    dragLeave: [{ type: Output, args: ['p-drag-leave',] }],
    dragOver: [{ type: Output, args: ['p-drag-over',] }],
    fileChange: [{ type: Output, args: ['p-file-change',] }],
    onDragLeave: [{ type: HostListener, args: ['document:dragleave', ['$event'],] }],
    onDragOver: [{ type: HostListener, args: ['document:dragover', ['$event'],] }],
    onDrop: [{ type: HostListener, args: ['document:drop', ['$event'],] }]
};
if (false) {
    /** @type {?} */
    PoUploadDragDropDirective.prototype.timeout;
    /**
     * @type {?}
     * @private
     */
    PoUploadDragDropDirective.prototype.files;
    /**
     * @type {?}
     * @private
     */
    PoUploadDragDropDirective.prototype.invalidFileType;
    /** @type {?} */
    PoUploadDragDropDirective.prototype.areaElement;
    /** @type {?} */
    PoUploadDragDropDirective.prototype.directoryCompatible;
    /** @type {?} */
    PoUploadDragDropDirective.prototype.disabled;
    /** @type {?} */
    PoUploadDragDropDirective.prototype.literals;
    /** @type {?} */
    PoUploadDragDropDirective.prototype.dragLeave;
    /** @type {?} */
    PoUploadDragDropDirective.prototype.dragOver;
    /** @type {?} */
    PoUploadDragDropDirective.prototype.fileChange;
    /**
     * @type {?}
     * @private
     */
    PoUploadDragDropDirective.prototype.i18nPipe;
    /**
     * @type {?}
     * @private
     */
    PoUploadDragDropDirective.prototype.notification;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdXBsb2FkLWRyYWctZHJvcC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS11aS8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3BvLWZpZWxkL3BvLXVwbG9hZC9wby11cGxvYWQtZHJhZy1kcm9wL3BvLXVwbG9hZC1kcmFnLWRyb3AuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDhEQUE4RCxDQUFDO0FBT3JHLE1BQU0sT0FBTyx5QkFBeUI7Ozs7O0lBcUJwQyxZQUFvQixRQUFvQixFQUFVLFlBQW1DO1FBQWpFLGFBQVEsR0FBUixRQUFRLENBQVk7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBdUI7UUFON0QsY0FBUyxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBRXhELGFBQVEsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUVwRCxlQUFVLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7SUFFUSxDQUFDOzs7OztJQUUxQyxXQUFXLENBQUMsS0FBSztRQUMvRCxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdkIsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRXhCLElBQUksQ0FBQyxPQUFPLEdBQUcsVUFBVTs7O1FBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsR0FBRSxFQUFFLENBQUMsQ0FBQztJQUM3RCxDQUFDOzs7OztJQUU4QyxVQUFVLENBQUMsS0FBSztRQUM3RCxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdkIsS0FBSyxDQUFD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RWxCLE1BQU0sU0FBQyxjQUFjO3VCQUVyQixNQUFNLFNBQUMsYUFBYTt5QkFFcEIsTUFBTSxTQUFDLGVBQWU7MEJBSXRCLFlBQVksU0FBQyxvQkFBb0IsRUFBRSxDQUFDLFFBQVEsQ0FBQzt5QkFPN0MsWUFBWSxTQUFDLG1CQUFtQixFQUFFLENBQUMsUUFBUSxDQUFDO3FCQVc1QyxZQUFZLFNBQUMsZUFBZSxFQUFFLENBQUMsUUFBUSxDQUFDOzs7O0lBdkN6Qyw0Q0FBYTs7Ozs7SUFFYiwwQ0FBMkI7Ozs7O0lBQzNCLG9EQUFnQzs7SUFFaEMsZ0RBQWtEOztJQUVsRCx3REFBOEQ7O0lBRTlELDZDQUF1Qzs7SUFFdkMsNkNBQWdEOztJQUVoRCw4Q0FBK0U7O0lBRS9FLDZDQUE2RTs7SUFFN0UsK0NBQWlGOzs7OztJQUVyRSw2Q0FBNEI7Ozs7O0lBQUUsaURBQTJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFdmVudEVtaXR0ZXIsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgUG9JMThuUGlwZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NlcnZpY2VzL3BvLWkxOG4vcG8taTE4bi5waXBlJztcclxuaW1wb3J0IHsgUG9Ob3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2VydmljZXMvcG8tbm90aWZpY2F0aW9uL3BvLW5vdGlmaWNhdGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUG9VcGxvYWRMaXRlcmFscyB9IGZyb20gJy4uL2ludGVyZmFjZXMvcG8tdXBsb2FkLWxpdGVyYWxzLmludGVyZmFjZSc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1twLXVwbG9hZC1kcmFnLWRyb3BdJyxcclxuICBwcm92aWRlcnM6IFsgUG9JMThuUGlwZSBdXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb1VwbG9hZERyYWdEcm9wRGlyZWN0aXZlIHtcclxuXHJcbiAgdGltZW91dDogYW55O1xyXG5cclxuICBwcml2YXRlIGZpbGVzOiBBcnJheTxGaWxlPjtcclxuICBwcml2YXRlIGludmFsaWRGaWxlVHlwZTogbnVtYmVyO1xyXG5cclxuICBASW5wdXQoJ3AtYXJlYS1lbGVtZW50JykgYXJlYUVsZW1lbnQ6IEhUTUxFbGVtZW50O1xyXG5cclxuICBASW5wdXQoJ3AtZGlyZWN0b3J5LWNvbXBhdGlibGUnKSBkaXJlY3RvcnlDb21wYXRpYmxlOiBib29sZWFuO1xyXG5cclxuICBASW5wdXQoJ3AtZGlzYWJsZWQnKSBkaXNhYmxlZDogYm9vbGVhbjtcclxuXHJcbiAgQElucHV0KCdwLWxpdGVyYWxzJykgbGl0ZXJhbHM6IFBvVXBsb2FkTGl0ZXJhbHM7XHJcblxyXG4gIEBPdXRwdXQoJ3AtZHJhZy1sZWF2ZScpIGRyYWdMZWF2ZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgQE91dHB1dCgncC1kcmFnLW92ZXInKSBkcmFnT3ZlcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgQE91dHB1dCgncC1maWxlLWNoYW5nZScpIGZpbGVDaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaTE4blBpcGU6IFBvSTE4blBpcGUsIHByaXZhdGUgbm90aWZpY2F0aW9uOiBQb05vdGlmaWNhdGlvblNlcnZpY2UpIHsgfVxyXG5cclxuICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDpkcmFnbGVhdmUnLCBbJyRldmVudCddKSBvbkRyYWdMZWF2ZShldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cclxuICAgIHRoaXMudGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5kcmFnTGVhdmUuZW1pdCgpLCAzMCk7XHJcbiAgfVxyXG5cclxuICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDpkcmFnb3ZlcicsIFsnJGV2ZW50J10pIG9uRHJhZ092ZXIoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KTtcclxuXHJcbiAgICBpZiAoIXRoaXMuZGlzYWJsZWQpIHtcclxuICAgICAgdGhpcy5kcmFnT3Zlci5lbWl0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDpkcm9wJywgWyckZXZlbnQnXSkgb25Ecm9wKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblxyXG4gICAgdGhpcy5nZXRGaWxlc0Zyb21EYXRhVHJhbnNmZXJJdGVtcyhldmVudCk7XHJcbiAgICB0aGlzLmRyYWdMZWF2ZS5lbWl0KCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEZpbGVzRnJvbURhdGFUcmFuc2Zlckl0ZW1zKGV2ZW50OiBEcmFnRXZlbnQpIHtcclxuICAgIGlmICghdGhpcy5kaXNhYmxlZCkge1xyXG4gICAgICB0aGlzLmludmFsaWRGaWxlVHlwZSA9IDA7XHJcbiAgICAgIGlmICh0aGlzLmRpcmVjdG9yeUNvbXBhdGlibGUpIHtcclxuICAgICAgICB0aGlzLmdldE9ubHlEaXJlY3RvcmllcyhldmVudC5kYXRhVHJhbnNmZXIuaXRlbXMpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zZW5kRmlsZXMoZXZlbnQsIHRoaXMuZmlsZXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5nZXRPbmx5RmlsZXMoZXZlbnQuZGF0YVRyYW5zZmVyLmZpbGVzKTtcclxuICAgICAgICB0aGlzLnNlbmRGaWxlcyhldmVudCwgZmlsZXMpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBhbmFsaXNhIGFzIGVudHJhZGFzIHJlY3Vyc2l2YW1lbnRlXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRGaWxlc0Zyb21FbnRyeShlbnRyeSkge1xyXG4gICAgaWYgKGVudHJ5LmlzRmlsZSkge1xyXG4gICAgICBjb25zdCBmaWxlID0gYXdhaXQgdGhpcy5yZWFkRmlsZShlbnRyeSk7XHJcbiAgICAgIHJldHVybiBbZmlsZV07XHJcbiAgICB9IGVsc2UgaWYgKGVudHJ5LmlzRGlyZWN0b3J5KSB7XHJcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJlYWREaXJlY3RvcnkoZW50cnkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRPbmx5RGlyZWN0b3JpZXMoZGF0YVRyYW5zZmVySXRlbXMpIHtcclxuICAgIGNvbnN0IGVudHJpZXMgPSBbXTtcclxuXHJcbiAgICAvLyBsaXN0YSB0b2RhcyBhcyBlbnRyYWRhcyBhbnRlcyBkZSBhbmFsaXPDoS1sYXNcclxuICAgIGZvciAoY29uc3QgaXRlbSBvZiBkYXRhVHJhbnNmZXJJdGVtcykge1xyXG4gICAgICBlbnRyaWVzLnB1c2goaXRlbS53ZWJraXRHZXRBc0VudHJ5KCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZmlsZXMgPSBbXTtcclxuICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykge1xyXG4gICAgICBpZiAoZW50cnkuaXNGaWxlKSB7XHJcbiAgICAgICAgdGhpcy5pbnZhbGlkRmlsZVR5cGUrKztcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBuZXdGaWxlcyA9IGF3YWl0IHRoaXMuZ2V0RmlsZXNGcm9tRW50cnkoZW50cnkpO1xyXG4gICAgICAgIHRoaXMuZmlsZXMgPSB0aGlzLmZpbGVzLmNvbmNhdChuZXdGaWxlcyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIHJldHVybiBvbmx5IGZpbGVzLiBJZiBpdCBpcyBhIGRpcmVjdG9yeSwgaW52YWxpZEZpbGVUeXBlIGNvdW50cy5cclxuICBwcml2YXRlIGdldE9ubHlGaWxlcyhmaWxlTGlzdDogRmlsZUxpc3QpOiBBcnJheTxGaWxlPiB7XHJcbiAgICByZXR1cm4gQXJyYXkuZnJvbShmaWxlTGlzdCkucmVkdWNlKChuZXdGaWxlcywgZmlsZSkgPT4ge1xyXG4gICAgICBpZiAoZmlsZS50eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ld0ZpbGVzLmNvbmNhdChmaWxlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmludmFsaWRGaWxlVHlwZSsrO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBuZXdGaWxlcztcclxuICAgIH0sIFtdKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVhZEZpbGUoZW50cnkpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcclxuICAgICAgZW50cnkuZmlsZShmaWxlID0+IHtcclxuICAgICAgICByZXNvbHZlKGZpbGUpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyByZWFkRGlyZWN0b3J5KGVudHJ5KSB7XHJcbiAgICBjb25zdCBkaXJSZWFkZXIgPSBlbnRyeS5jcmVhdGVSZWFkZXIoKTtcclxuICAgIGxldCBmaWxlcyA9IFtdO1xyXG4gICAgbGV0IG5ld0ZpbGVzO1xyXG5cclxuICAgIG5ld0ZpbGVzID0gYXdhaXQgdGhpcy5yZWFkRGlyZWN0b3J5RW50cmllcyhkaXJSZWFkZXIpO1xyXG4gICAgZmlsZXMgPSBmaWxlcy5jb25jYXQobmV3RmlsZXMpO1xyXG4gICAgcmV0dXJuIGZpbGVzO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWFkRGlyZWN0b3J5RW50cmllcyhkaXJSZWFkZXIpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcclxuICAgICAgZGlyUmVhZGVyLnJlYWRFbnRyaWVzKGFzeW5jIGVudHJpZXMgPT4ge1xyXG4gICAgICAgIGxldCBmaWxlcyA9IFtdO1xyXG4gICAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykge1xyXG4gICAgICAgICAgY29uc3QgaXRlbUZpbGVzID0gYXdhaXQgdGhpcy5nZXRGaWxlc0Zyb21FbnRyeShlbnRyeSk7XHJcbiAgICAgICAgICBmaWxlcyA9IGZpbGVzLmNvbmNhdChpdGVtRmlsZXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXNvbHZlKGZpbGVzKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2VuZEZlZWRiYWNrKGludmFsaWRGaWxlczogbnVtYmVyKSB7XHJcbiAgICBpZiAoaW52YWxpZEZpbGVzKSB7XHJcbiAgICAgIHRoaXMuc2V0UGlwZUFyZ3VtZW50cygnaW52YWxpZEZpbGVUeXBlJywgaW52YWxpZEZpbGVzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2VuZEZpbGVzKGV2ZW50LCBmaWxlcykge1xyXG4gICAgaWYgKHRoaXMuYXJlYUVsZW1lbnQuY29udGFpbnMoZXZlbnQudGFyZ2V0KSkge1xyXG5cclxuICAgICAgaWYgKGZpbGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICB0aGlzLmZpbGVDaGFuZ2UuZW1pdChmaWxlcyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuc2VuZEZlZWRiYWNrKHRoaXMuaW52YWxpZEZpbGVUeXBlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGludmFsaWREcm9wQXJlYUFyZyA9IHRoaXMuZGlyZWN0b3J5Q29tcGF0aWJsZSA/IHRoaXMubGl0ZXJhbHMuZm9sZGVycyA6IHRoaXMubGl0ZXJhbHMuZmlsZXM7XHJcbiAgICAgIHRoaXMuc2V0UGlwZUFyZ3VtZW50cygnaW52YWxpZERyb3BBcmVhJywgaW52YWxpZERyb3BBcmVhQXJnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIG3DqXRvZG8gcmVzcG9uc8OhdmVsIHBvciBzZXRhciBvcyBhcmd1bWVudG9zIGRvIGkxOG5QaXBlLlxyXG4gIHByaXZhdGUgc2V0UGlwZUFyZ3VtZW50cyhsaXRlcmFsQXR0cmlidXRlczogc3RyaW5nLCBhcmdzPykge1xyXG4gICAgY29uc3QgcGlwZUFyZ3VtZW50cyA9IHRoaXMuaTE4blBpcGUudHJhbnNmb3JtKHRoaXMubGl0ZXJhbHNbbGl0ZXJhbEF0dHJpYnV0ZXNdLCBhcmdzKTtcclxuICAgIHRoaXMubm90aWZpY2F0aW9uLmluZm9ybWF0aW9uKHBpcGVBcmd1bWVudHMpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19