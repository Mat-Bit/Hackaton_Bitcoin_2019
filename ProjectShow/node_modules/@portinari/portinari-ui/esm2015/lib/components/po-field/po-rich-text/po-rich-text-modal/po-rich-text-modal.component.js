/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Output, ViewChild } from '@angular/core';
import { NgForm } from '@angular/forms';
import { convertImageToBase64 } from '../../../../utils/util';
import { PoLanguageService } from './../../../../services/po-language/po-language.service';
import { PoModalComponent } from '../../../po-modal';
import { poRichTextLiteralsDefault } from '../po-rich-text-literals';
import { PoRichTextModalType } from '../enums/po-rich-text-modal-type.enum';
import { PoUploadComponent } from '../../po-upload/po-upload.component';
/** @type {?} */
const uploadRestrictions = ['.apng', '.bmp', '.gif', '.ico', '.jpeg', '.jpg', '.png', '.svg'];
export class PoRichTextModalComponent {
    /**
     * @param {?} languageService
     */
    constructor(languageService) {
        this.languageService = languageService;
        this.selection = document.getSelection();
        this.uploadRestrictions = {
            allowedExtensions: uploadRestrictions
        };
        this.literals = Object.assign({}, poRichTextLiteralsDefault[this.languageService.getShortLanguage()]);
        this.modalCancelAction = {
            label: this.literals.cancel,
            action: (/**
             * @return {?}
             */
            () => {
                this.modal.close();
                this.cleanUpFields();
            })
        };
        this.modalConfirmAction = {
            label: this.literals.insert,
            disabled: false,
            action: (/**
             * @return {?}
             */
            () => this.insertElementRef())
        };
        this.modalLinkConfirmAction = {
            label: this.literals.insertLink,
            disabled: true,
            action: (/**
             * @return {?}
             */
            () => this.toInsertLink(this.urlLink, this.urlLinkText))
        };
        this.command = new EventEmitter();
    }
    /**
     * @return {?}
     */
    get modalTitle() {
        return this.modalType === 'image' ? this.literals.insertImage : this.literals.insertLink;
    }
    /**
     * @return {?}
     */
    get isUploadValid() {
        return !!(this.uploadModel && this.uploadModel.length);
    }
    /**
     * @return {?}
     */
    get isUrlValid() {
        return !!this.urlImage && this.modalImageForm && this.modalImageForm.valid;
    }
    /**
     * @return {?}
     */
    get modalPrimaryAction() {
        return this.modalType === 'image' ? this.modalConfirmAction : this.modalLinkConfirmAction;
    }
    /**
     * @return {?}
     */
    convertToBase64() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (this.isUploadValid) {
                /** @type {?} */
                const uploadImage = this.uploadModel[0].rawFile;
                return yield convertImageToBase64(uploadImage);
            }
        });
    }
    /**
     * @param {?} value
     * @return {?}
     */
    emitCommand(value) {
        /** @type {?} */
        let command;
        if (value && this.modalType === PoRichTextModalType.Image) {
            command = 'insertImage';
            this.command.emit(({ command, value }));
        }
    }
    /**
     * @return {?}
     */
    formModelValidate() {
        return this.modalLinkConfirmAction.disabled = this.modalLinkForm && this.modalLinkForm.invalid;
    }
    /**
     * @return {?}
     */
    insertElementRef() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            let uploadImage;
            if (this.modalType === PoRichTextModalType.Image && !this.urlImage) {
                uploadImage = yield this.convertToBase64();
            }
            this.retrieveCursorPosition();
            this.modal.close();
            if (this.isUrlValid || this.isUploadValid) {
                this.emitCommand(this.urlImage || uploadImage);
            }
            this.cleanUpFields();
        });
    }
    /**
     * @param {?} type
     * @return {?}
     */
    openModal(type) {
        this.modalType = type;
        if (this.modalType === PoRichTextModalType.Image) {
            this.saveCursorPosition();
        }
        else {
            this.saveSelectionTextRange();
            this.formReset(this.modalLinkForm.control);
            this.formModelValidate();
        }
        this.modal.open();
    }
    /**
     * @private
     * @param {?} urlLink
     * @param {?} urlLinkText
     * @return {?}
     */
    checkIfIsEmpty(urlLink, urlLinkText) {
        return urlLinkText === undefined || urlLinkText.trim() === '' ? urlLink : urlLinkText;
    }
    /**
     * @private
     * @return {?}
     */
    cleanUpFields() {
        this.urlImage = undefined;
        this.urlLink = undefined;
        this.urlLinkText = undefined;
        this.uploadModel = undefined;
    }
    /**
     * @private
     * @param {?} control
     * @return {?}
     */
    formReset(control) {
        control.markAsPristine();
        control.markAsUntouched();
        control.updateValueAndValidity();
    }
    /**
     * @private
     * @return {?}
     */
    restoreSelection() {
        if (this.savedSelection) {
            if (this.selection) {
                this.selection.removeAllRanges();
                this.selection.addRange(this.savedSelection);
            }
            return true;
        }
        else {
            return false;
        }
    }
    /**
     * @private
     * @return {?}
     */
    retrieveCursorPosition() {
        this.selection.collapse(this.savedCursorPosition[0], this.savedCursorPosition[1]);
    }
    /**
     * @private
     * @return {?}
     */
    saveCursorPosition() {
        this.savedCursorPosition = [this.selection.focusNode, this.selection.focusOffset];
    }
    /**
     * @private
     * @return {?}
     */
    saveSelectionTextRange() {
        if (this.selection.anchorNode !== null) {
            this.savedSelection = this.selection.getRangeAt(0);
            this.urlLinkText = this.selection.toString();
        }
        else {
            return null;
        }
    }
    /**
     * @private
     * @param {?} urlLink
     * @param {?} urlLinkText
     * @return {?}
     */
    toInsertLink(urlLink, urlLinkText) {
        this.modal.close();
        this.restoreSelection();
        /** @type {?} */
        const urlLinkTextValue = this.checkIfIsEmpty(urlLink, urlLinkText);
        /** @type {?} */
        const command = 'InsertHTML';
        /** @type {?} */
        const value = { urlLink: urlLink, urlLinkText: urlLinkTextValue };
        this.command.emit({ command, value });
        this.cleanUpFields();
    }
}
PoRichTextModalComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-rich-text-modal',
                template: "<po-modal #modal\r\n  p-hide-close\r\n  [p-primary-action]=\"modalPrimaryAction\"\r\n  [p-secondary-action]=\"modalCancelAction\"\r\n  [p-title]=\"modalTitle\">\r\n\r\n  <ng-container *ngTemplateOutlet=\"modalType === 'image' ? modalImage : modalLink\"></ng-container>\r\n</po-modal>\r\n\r\n<ng-template #modalImage>\r\n  <form #modalImageForm=\"ngForm\">\r\n    <div class=\"po-row\">\r\n      <!-- po-upload desabilita o drag drop caso n\u00E3o tenha valor atribuido para a propriedade p-url -->\r\n      <po-upload #upload\r\n        class=\"po-md-12\"\r\n        name=\"upload\"\r\n        [(ngModel)]=\"uploadModel\"\r\n        p-drag-drop-height=\"160\"\r\n        p-hide-restrictions-info\r\n        p-hide-send-button\r\n        p-url=\"x\"\r\n        [p-drag-drop]=\"!modal.isHidden\"\r\n        [p-disabled]=\"isUrlValid\"\r\n        [p-restrictions]=\"uploadRestrictions\">\r\n      </po-upload>\r\n    </div>\r\n\r\n    <div class=\"po-row\">\r\n      <po-url\r\n        class=\"po-md-12 po-mt-3\"\r\n        name=\"url\"\r\n        [(ngModel)]=\"urlImage\"\r\n        [p-label]=\"literals.urlImage\"\r\n        [p-disabled]=\"isUploadValid\">\r\n      </po-url>\r\n    </div>\r\n  </form>\r\n</ng-template>\r\n\r\n<ng-template #modalLink>\r\n  <form #modalLinkForm=\"ngForm\">\r\n    <div class=\"po-row\">\r\n      <po-input class=\"po-md-12 po-mb-2\"\r\n        name=\"urlLinkText\"\r\n        [(ngModel)]=\"urlLinkText\"\r\n        p-optional\r\n        [p-label]=\"literals.linkTextLabel\"\r\n        [p-placeholder]=\"literals.linkTextLabel\">\r\n      </po-input>\r\n\r\n      <po-url class=\"po-md-12\"\r\n        name=\"urlLink\"\r\n        [(ngModel)]=\"urlLink\"\r\n        p-label=\"Link\"\r\n        p-required\r\n        [p-help]=\"literals.linkUrlTextHelper\"\r\n        [p-placeholder]=\"literals.linkUrlTextPlaceholder\"\r\n        (p-change-model)=\"formModelValidate()\">\r\n      </po-url>\r\n    </div>\r\n  </form>\r\n</ng-template>\r\n"
            }] }
];
/** @nocollapse */
PoRichTextModalComponent.ctorParameters = () => [
    { type: PoLanguageService }
];
PoRichTextModalComponent.propDecorators = {
    modal: [{ type: ViewChild, args: ['modal', { static: true },] }],
    modalImageForm: [{ type: ViewChild, args: ['modalImageForm', { static: false },] }],
    upload: [{ type: ViewChild, args: ['upload', { static: true },] }],
    modalImage: [{ type: ViewChild, args: ['modalImage', { static: true },] }],
    modalLink: [{ type: ViewChild, args: ['modalLink', { static: true },] }],
    modalLinkForm: [{ type: ViewChild, args: ['modalLinkForm', { static: false },] }],
    command: [{ type: Output, args: ['p-command',] }]
};
if (false) {
    /** @type {?} */
    PoRichTextModalComponent.prototype.modalType;
    /** @type {?} */
    PoRichTextModalComponent.prototype.savedCursorPosition;
    /** @type {?} */
    PoRichTextModalComponent.prototype.selection;
    /** @type {?} */
    PoRichTextModalComponent.prototype.uploadModel;
    /** @type {?} */
    PoRichTextModalComponent.prototype.uploadRestrictions;
    /** @type {?} */
    PoRichTextModalComponent.prototype.urlImage;
    /** @type {?} */
    PoRichTextModalComponent.prototype.urlLink;
    /** @type {?} */
    PoRichTextModalComponent.prototype.urlLinkText;
    /**
     * @type {?}
     * @private
     */
    PoRichTextModalComponent.prototype.savedSelection;
    /** @type {?} */
    PoRichTextModalComponent.prototype.literals;
    /** @type {?} */
    PoRichTextModalComponent.prototype.modalCancelAction;
    /** @type {?} */
    PoRichTextModalComponent.prototype.modalConfirmAction;
    /** @type {?} */
    PoRichTextModalComponent.prototype.modalLinkConfirmAction;
    /** @type {?} */
    PoRichTextModalComponent.prototype.modal;
    /** @type {?} */
    PoRichTextModalComponent.prototype.modalImageForm;
    /** @type {?} */
    PoRichTextModalComponent.prototype.upload;
    /** @type {?} */
    PoRichTextModalComponent.prototype.modalImage;
    /** @type {?} */
    PoRichTextModalComponent.prototype.modalLink;
    /** @type {?} */
    PoRichTextModalComponent.prototype.modalLinkForm;
    /** @type {?} */
    PoRichTextModalComponent.prototype.command;
    /**
     * @type {?}
     * @private
     */
    PoRichTextModalComponent.prototype.languageService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LW1vZGFsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwb3J0aW5hcmkvcG9ydGluYXJpLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tZmllbGQvcG8tcmljaC10ZXh0L3BvLXJpY2gtdGV4dC1tb2RhbC9wby1yaWNoLXRleHQtbW9kYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkYsT0FBTyxFQUFtQixNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV6RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQUUzRixPQUFPLEVBQWlCLGdCQUFnQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDckUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDNUUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0scUNBQXFDLENBQUM7O01BR2xFLGtCQUFrQixHQUFHLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQztBQU03RixNQUFNLE9BQU8sd0JBQXdCOzs7O0lBcUVuQyxZQUFvQixlQUFrQztRQUFsQyxvQkFBZSxHQUFmLGVBQWUsQ0FBbUI7UUFqRXRELGNBQVMsR0FBRyxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFcEMsdUJBQWtCLEdBQTZCO1lBQzdDLGlCQUFpQixFQUFFLGtCQUFrQjtTQUN0QyxDQUFDO1FB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MkNBQWdCOztJQUNoQiwrQ0FBb0I7Ozs7O0lBRXBCLGtEQUFxQzs7SUFFckMsNENBRUU7O0lBRUYscURBTUU7O0lBRUYsc0RBSUU7O0lBRUYsMERBSUU7O0lBa0JGLHlDQUE4RDs7SUFFOUQsa0RBQXVFOztJQUV2RSwwQ0FBaUU7O0lBRWpFLDhDQUFrRTs7SUFFbEUsNkNBQXNFOztJQUV0RSxpREFBcUU7O0lBRXJFLDJDQUFxRzs7Ozs7SUFFekYsbURBQTBDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIE91dHB1dCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5cclxuaW1wb3J0IHsgY29udmVydEltYWdlVG9CYXNlNjQgfSBmcm9tICcuLi8uLi8uLi8uLi91dGlscy91dGlsJztcclxuaW1wb3J0IHsgUG9MYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLy4uLy4uLy4uLy4uL3NlcnZpY2VzL3BvLWxhbmd1YWdlL3BvLWxhbmd1YWdlLnNlcnZpY2UnO1xyXG5cclxuaW1wb3J0IHsgUG9Nb2RhbEFjdGlvbiwgUG9Nb2RhbENvbXBvbmVudCB9IGZyb20gJy4uLy4uLy4uL3BvLW1vZGFsJztcclxuaW1wb3J0IHsgcG9SaWNoVGV4dExpdGVyYWxzRGVmYXVsdCB9IGZyb20gJy4uL3BvLXJpY2gtdGV4dC1saXRlcmFscyc7XHJcbmltcG9ydCB7IFBvUmljaFRleHRNb2RhbFR5cGUgfSBmcm9tICcuLi9lbnVtcy9wby1yaWNoLXRleHQtbW9kYWwtdHlwZS5lbnVtJztcclxuaW1wb3J0IHsgUG9VcGxvYWRDb21wb25lbnQgfSBmcm9tICcuLi8uLi9wby11cGxvYWQvcG8tdXBsb2FkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFBvVXBsb2FkRmlsZVJlc3RyaWN0aW9ucyB9IGZyb20gJy4uLy4uL3BvLXVwbG9hZC9pbnRlcmZhY2VzL3BvLXVwbG9hZC1maWxlLXJlc3RyaWN0aW9uLmludGVyZmFjZSc7XHJcblxyXG5jb25zdCB1cGxvYWRSZXN0cmljdGlvbnMgPSBbJy5hcG5nJywgJy5ibXAnLCAnLmdpZicsICcuaWNvJywgJy5qcGVnJywgJy5qcGcnLCAnLnBuZycsICcuc3ZnJ107XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3BvLXJpY2gtdGV4dC1tb2RhbCcsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLXJpY2gtdGV4dC1tb2RhbC5jb21wb25lbnQuaHRtbCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFBvUmljaFRleHRNb2RhbENvbXBvbmVudCB7XHJcblxyXG4gIG1vZGFsVHlwZTogUG9SaWNoVGV4dE1vZGFsVHlwZTtcclxuICBzYXZlZEN1cnNvclBvc2l0aW9uO1xyXG4gIHNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xyXG4gIHVwbG9hZE1vZGVsOiBBcnJheTxhbnk+O1xyXG4gIHVwbG9hZFJlc3RyaWN0aW9uczogUG9VcGxvYWRGaWxlUmVzdHJpY3Rpb25zID0ge1xyXG4gICAgYWxsb3dlZEV4dGVuc2lvbnM6IHVwbG9hZFJlc3RyaWN0aW9uc1xyXG4gIH07XHJcbiAgdXJsSW1hZ2U6IHN0cmluZztcclxuICB1cmxMaW5rOiBzdHJpbmc7XHJcbiAgdXJsTGlua1RleHQ6IHN0cmluZztcclxuXHJcbiAgcHJpdmF0ZSBzYXZlZFNlbGVjdGlvbjogUmFuZ2UgfCBudWxsO1xyXG5cclxuICByZWFkb25seSBsaXRlcmFscyA9IHtcclxuICAgIC4uLnBvUmljaFRleHRMaXRlcmFsc0RlZmF1bHRbdGhpcy5sYW5ndWFnZVNlcnZpY2UuZ2V0U2hvcnRMYW5ndWFnZSgpXVxyXG4gIH07XHJcblxyXG4gIG1vZGFsQ2FuY2VsQWN0aW9uOiBQb01vZGFsQWN0aW9uID0ge1xyXG4gICAgbGFiZWw6IHRoaXMubGl0ZXJhbHMuY2FuY2VsLFxyXG4gICAgYWN0aW9uOiAoKSA9PiB7XHJcbiAgICAgIHRoaXMubW9kYWwuY2xvc2UoKTtcclxuICAgICAgdGhpcy5jbGVhblVwRmllbGRzKCk7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgbW9kYWxDb25maXJtQWN0aW9uOiBQb01vZGFsQWN0aW9uID0ge1xyXG4gICAgbGFiZWw6IHRoaXMubGl0ZXJhbHMuaW5zZXJ0LFxyXG4gICAgZGlzYWJsZWQ6IGZhbHNlLFxyXG4gICAgYWN0aW9uOiAoKSA9PiB0aGlzLmluc2VydEVsZW1lbnRSZWYoKVxyXG4gIH07XHJcblxyXG4gIG1vZGFsTGlua0NvbmZpcm1BY3Rpb24gPSB7XHJcbiAgICBsYWJlbDogdGhpcy5saXRlcmFscy5pbnNlcnRMaW5rLFxyXG4gICAgZGlzYWJsZWQ6IHRydWUsXHJcbiAgICBhY3Rpb246ICgpID0+IHRoaXMudG9JbnNlcnRMaW5rKHRoaXMudXJsTGluaywgdGhpcy51cmxMaW5rVGV4dClcclxuICB9O1xyXG5cclxuICBnZXQgbW9kYWxUaXRsZSgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMubW9kYWxUeXBlID09PSAnaW1hZ2UnID8gdGhpcy5saXRlcmFscy5pbnNlcnRJbWFnZSA6IHRoaXMubGl0ZXJhbHMuaW5zZXJ0TGluaztcclxuICB9XHJcblxyXG4gIGdldCBpc1VwbG9hZFZhbGlkKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICEhKHRoaXMudXBsb2FkTW9kZWwgJiYgdGhpcy51cGxvYWRNb2RlbC5sZW5ndGgpO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGlzVXJsVmFsaWQoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gISF0aGlzLnVybEltYWdlICYmIHRoaXMubW9kYWxJbWFnZUZvcm0gJiYgdGhpcy5tb2RhbEltYWdlRm9ybS52YWxpZDtcclxuICB9XHJcblxyXG4gIGdldCBtb2RhbFByaW1hcnlBY3Rpb24oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5tb2RhbFR5cGUgPT09ICdpbWFnZScgPyB0aGlzLm1vZGFsQ29uZmlybUFjdGlvbiA6IHRoaXMubW9kYWxMaW5rQ29uZmlybUFjdGlvbjtcclxuICB9XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ21vZGFsJywgeyBzdGF0aWM6IHRydWUgfSkgbW9kYWw6IFBvTW9kYWxDb21wb25lbnQ7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ21vZGFsSW1hZ2VGb3JtJywgeyBzdGF0aWM6IGZhbHNlIH0pIG1vZGFsSW1hZ2VGb3JtOiBOZ0Zvcm07XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ3VwbG9hZCcsIHsgc3RhdGljOiB0cnVlIH0pIHVwbG9hZDogUG9VcGxvYWRDb21wb25lbnQ7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ21vZGFsSW1hZ2UnLCB7IHN0YXRpYzogdHJ1ZSB9KSBtb2RhbEltYWdlOiBFbGVtZW50UmVmO1xyXG5cclxuICBAVmlld0NoaWxkKCdtb2RhbExpbmsnLCB7IHN0YXRpYzogdHJ1ZSB9KSBtb2RhbExpbms6IFBvTW9kYWxDb21wb25lbnQ7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ21vZGFsTGlua0Zvcm0nLCB7IHN0YXRpYzogZmFsc2UgfSkgbW9kYWxMaW5rRm9ybTogTmdGb3JtO1xyXG5cclxuICBAT3V0cHV0KCdwLWNvbW1hbmQnKSBjb21tYW5kID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmcgfCB7IGNvbW1hbmQ6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IGFueSB9PigpO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxhbmd1YWdlU2VydmljZTogUG9MYW5ndWFnZVNlcnZpY2UpIHt9XHJcblxyXG4gIGFzeW5jIGNvbnZlcnRUb0Jhc2U2NCgpIHtcclxuICAgIGlmICh0aGlzLmlzVXBsb2FkVmFsaWQpIHtcclxuICAgICAgY29uc3QgdXBsb2FkSW1hZ2UgPSB0aGlzLnVwbG9hZE1vZGVsWzBdLnJhd0ZpbGU7XHJcbiAgICAgIHJldHVybiBhd2FpdCBjb252ZXJ0SW1hZ2VUb0Jhc2U2NCh1cGxvYWRJbWFnZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBlbWl0Q29tbWFuZCh2YWx1ZSkge1xyXG4gICAgbGV0IGNvbW1hbmQ6IHN0cmluZztcclxuICAgIGlmICh2YWx1ZSAmJiB0aGlzLm1vZGFsVHlwZSA9PT0gUG9SaWNoVGV4dE1vZGFsVHlwZS5JbWFnZSkge1xyXG4gICAgICBjb21tYW5kID0gJ2luc2VydEltYWdlJztcclxuICAgICAgdGhpcy5jb21tYW5kLmVtaXQoKHsgY29tbWFuZCwgdmFsdWUgfSkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZm9ybU1vZGVsVmFsaWRhdGUoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5tb2RhbExpbmtDb25maXJtQWN0aW9uLmRpc2FibGVkID0gdGhpcy5tb2RhbExpbmtGb3JtICYmIHRoaXMubW9kYWxMaW5rRm9ybS5pbnZhbGlkO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgaW5zZXJ0RWxlbWVudFJlZigpIHtcclxuXHJcbiAgICBsZXQgdXBsb2FkSW1hZ2U6IHN0cmluZztcclxuXHJcbiAgICBpZiAodGhpcy5tb2RhbFR5cGUgPT09IFBvUmljaFRleHRNb2RhbFR5cGUuSW1hZ2UgJiYgIXRoaXMudXJsSW1hZ2UpIHtcclxuICAgICAgdXBsb2FkSW1hZ2UgPSBhd2FpdCB0aGlzLmNvbnZlcnRUb0Jhc2U2NCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucmV0cmlldmVDdXJzb3JQb3NpdGlvbigpO1xyXG4gICAgdGhpcy5tb2RhbC5jbG9zZSgpO1xyXG5cclxuICAgIGlmICh0aGlzLmlzVXJsVmFsaWQgfHwgdGhpcy5pc1VwbG9hZFZhbGlkKSB7XHJcbiAgICAgIHRoaXMuZW1pdENvbW1hbmQodGhpcy51cmxJbWFnZSB8fCB1cGxvYWRJbWFnZSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmNsZWFuVXBGaWVsZHMoKTtcclxuICB9XHJcblxyXG4gIG9wZW5Nb2RhbCh0eXBlOiBQb1JpY2hUZXh0TW9kYWxUeXBlKSB7XHJcbiAgICB0aGlzLm1vZGFsVHlwZSA9IHR5cGU7XHJcblxyXG4gICAgaWYgKHRoaXMubW9kYWxUeXBlID09PSBQb1JpY2hUZXh0TW9kYWxUeXBlLkltYWdlKSB7XHJcbiAgICAgIHRoaXMuc2F2ZUN1cnNvclBvc2l0aW9uKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnNhdmVTZWxlY3Rpb25UZXh0UmFuZ2UoKTtcclxuICAgICAgdGhpcy5mb3JtUmVzZXQodGhpcy5tb2RhbExpbmtGb3JtLmNvbnRyb2wpO1xyXG4gICAgICB0aGlzLmZvcm1Nb2RlbFZhbGlkYXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5tb2RhbC5vcGVuKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNoZWNrSWZJc0VtcHR5KHVybExpbms6IHN0cmluZywgdXJsTGlua1RleHQ6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIHVybExpbmtUZXh0ID09PSB1bmRlZmluZWQgfHwgdXJsTGlua1RleHQudHJpbSgpID09PSAnJyA/IHVybExpbmsgOiB1cmxMaW5rVGV4dDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2xlYW5VcEZpZWxkcygpIHtcclxuICAgIHRoaXMudXJsSW1hZ2UgPSB1bmRlZmluZWQ7XHJcbiAgICB0aGlzLnVybExpbmsgPSB1bmRlZmluZWQ7XHJcbiAgICB0aGlzLnVybExpbmtUZXh0ID0gdW5kZWZpbmVkO1xyXG4gICAgdGhpcy51cGxvYWRNb2RlbCA9IHVuZGVmaW5lZDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZm9ybVJlc2V0KGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCkge1xyXG4gICAgY29udHJvbC5tYXJrQXNQcmlzdGluZSgpO1xyXG4gICAgY29udHJvbC5tYXJrQXNVbnRvdWNoZWQoKTtcclxuICAgIGNvbnRyb2wudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZXN0b3JlU2VsZWN0aW9uKCkge1xyXG4gICAgaWYgKHRoaXMuc2F2ZWRTZWxlY3Rpb24pIHtcclxuICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uKSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rpb24uYWRkUmFuZ2UodGhpcy5zYXZlZFNlbGVjdGlvbik7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9ICBlbHNlIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZXRyaWV2ZUN1cnNvclBvc2l0aW9uKCkge1xyXG4gICAgdGhpcy5zZWxlY3Rpb24uY29sbGFwc2UodGhpcy5zYXZlZEN1cnNvclBvc2l0aW9uWzBdLCB0aGlzLnNhdmVkQ3Vyc29yUG9zaXRpb25bMV0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzYXZlQ3Vyc29yUG9zaXRpb24oKSB7XHJcbiAgICB0aGlzLnNhdmVkQ3Vyc29yUG9zaXRpb24gPSBbIHRoaXMuc2VsZWN0aW9uLmZvY3VzTm9kZSwgdGhpcy5zZWxlY3Rpb24uZm9jdXNPZmZzZXQgXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2F2ZVNlbGVjdGlvblRleHRSYW5nZSgpIHtcclxuICAgIGlmICh0aGlzLnNlbGVjdGlvbi5hbmNob3JOb2RlICE9PSBudWxsKSB7XHJcbiAgICAgIHRoaXMuc2F2ZWRTZWxlY3Rpb24gPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZUF0KDApO1xyXG4gICAgICB0aGlzLnVybExpbmtUZXh0ID0gdGhpcy5zZWxlY3Rpb24udG9TdHJpbmcoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB0b0luc2VydExpbmsodXJsTGluaywgdXJsTGlua1RleHQpIHtcclxuICAgIHRoaXMubW9kYWwuY2xvc2UoKTtcclxuICAgIHRoaXMucmVzdG9yZVNlbGVjdGlvbigpO1xyXG5cclxuICAgIGNvbnN0IHVybExpbmtUZXh0VmFsdWUgPSB0aGlzLmNoZWNrSWZJc0VtcHR5KHVybExpbmssIHVybExpbmtUZXh0KTtcclxuICAgIGNvbnN0IGNvbW1hbmQ6IHN0cmluZyA9ICdJbnNlcnRIVE1MJztcclxuICAgIGNvbnN0IHZhbHVlID0geyB1cmxMaW5rOiB1cmxMaW5rLCB1cmxMaW5rVGV4dDogdXJsTGlua1RleHRWYWx1ZSB9O1xyXG5cclxuICAgIHRoaXMuY29tbWFuZC5lbWl0KHsgY29tbWFuZCwgdmFsdWUgfSk7XHJcblxyXG4gICAgdGhpcy5jbGVhblVwRmllbGRzKCk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=