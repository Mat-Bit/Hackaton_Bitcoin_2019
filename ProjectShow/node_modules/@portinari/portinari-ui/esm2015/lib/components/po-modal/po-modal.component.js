/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Component, ElementRef, Renderer2, ViewChild } from '@angular/core';
import { v4 as uuid } from 'uuid';
import { PoModalBaseComponent } from './po-modal-base.component';
import { PoModalService } from './po-modal-service';
/**
 * \@docsExtends PoModalBaseComponent
 *
 * \@example
 *
 * <example name="po-modal-basic" title="Portinari Modal Basic">
 *  <file name="sample-po-modal-basic/sample-po-modal-basic.component.html"> </file>
 *  <file name="sample-po-modal-basic/sample-po-modal-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-modal-labs" title="Portinari Modal Labs">
 *  <file name="sample-po-modal-labs/sample-po-modal-labs.component.html"> </file>
 *  <file name="sample-po-modal-labs/sample-po-modal-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-modal-fruits-salad" title="Portinari Modal - Fruits Salad">
 *  <file name="sample-po-modal-fruits-salad/sample-po-modal-fruits-salad.component.html"> </file>
 *  <file name="sample-po-modal-fruits-salad/sample-po-modal-fruits-salad.component.ts"> </file>
 * </example>
 */
export class PoModalComponent extends PoModalBaseComponent {
    /**
     * @param {?} poModalService
     * @param {?} renderer
     * @param {?} changeDetector
     */
    constructor(poModalService, renderer, changeDetector) {
        super();
        this.poModalService = poModalService;
        this.renderer = renderer;
        this.changeDetector = changeDetector;
        this.focusableElements = 'input, select, textarea, button:not([disabled]), a';
        this.id = uuid();
    }
    /**
     * @param {?=} xClosed
     * @return {?}
     */
    close(xClosed = false) {
        this.poModalService.modalActive = undefined;
        super.close(xClosed);
        this.removeEventListeners();
        if (this.sourceElement) {
            this.sourceElement.focus();
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    closeModalOnEscapeKey(event) {
        if (!this.hideClose) {
            event.preventDefault();
            event.stopPropagation();
            this.close();
        }
    }
    /**
     * @return {?}
     */
    getPrimaryActionButtonType() {
        return this.primaryAction.danger ? 'danger' : 'primary';
    }
    /**
     * @return {?}
     */
    getSecondaryActionButtonType() {
        return this.secondaryAction && this.secondaryAction.danger && !this.primaryAction.danger ? 'danger' : 'default';
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onClickOut(event) {
        if (this.clickOut && !this.modalContent.nativeElement.contains(event.target)) {
            this.close();
        }
    }
    /**
     * @return {?}
     */
    open() {
        this.sourceElement = document.activeElement;
        super.open();
        this.handleFocus();
    }
    /**
     * @private
     * @return {?}
     */
    handleFocus() {
        this.poModalService.modalActive = this.id;
        setTimeout((/**
         * @return {?}
         */
        () => {
            if (this.modalContent) {
                this.initFocus();
                document.addEventListener('focus', this.focusFunction, true);
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    initFocus() {
        this.focusFunction = (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            this.poModalService.modalActive = this.poModalService.modalActive || this.id;
            /** @type {?} */
            const modalElement = this.modalContent.nativeElement;
            if (!modalElement.contains(event.target) && this.poModalService.modalActive === this.id) {
                event.stopPropagation();
                this.firstElement.focus();
            }
        });
        this.setFirstElement();
        if (this.hideClose) {
            this.firstElement.focus();
        }
        else {
            /** @type {?} */
            const firstFieldElement = this.modalContent.nativeElement.querySelectorAll(this.focusableElements)[1] ||
                this.modalContent.nativeElement;
            firstFieldElement.focus();
        }
    }
    /**
     * @private
     * @return {?}
     */
    removeEventListeners() {
        document.removeEventListener('focus', this.focusFunction, true);
    }
    /**
     * @private
     * @return {?}
     */
    setFirstElement() {
        this.firstElement = this.modalContent.nativeElement.querySelector(this.focusableElements) || this.modalContent.nativeElement;
    }
}
PoModalComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-modal',
                template: "<div *ngIf=\"!isHidden\"\n  class=\"po-modal\"\n  tabindex=\"0\"\n  (keydown.esc)=\"closeModalOnEscapeKey($event)\">\n\n  <div class=\"po-modal-overlay\">\n    <div class=\"po-modal-container po-pb-2 po-pt-2\" (mousedown)=\"onClickOut($event)\">\n\n      <div class=\"po-modal-vertical-align\">\n        <div #modalContent\n          class=\"po-modal-content po-modal-{{ size }}\"\n          tabindex=\"-1\">\n\n          <div class=\"po-modal-header\">\n            <div class=\"po-modal-title po-text-ellipsis\">\n              {{ title }}\n            </div>\n\n            <a *ngIf=\"!hideClose\"\n              class=\"po-modal-header-close-button\"\n              tabindex=\"0\"\n              (click)=\"close(true)\">\n              <span class=\"po-icon po-icon-close\"></span>\n            </a>\n          </div>\n\n          <div class=\"po-modal-body\">\n            <ng-content></ng-content>\n          </div>\n\n          <div class=\"po-modal-footer\">\n            <po-button *ngIf=\"secondaryAction\"\n              [p-disabled]=\"secondaryAction.disabled\"\n              [p-label]=\"secondaryAction.label\"\n              [p-loading]=\"secondaryAction.loading\"\n              [p-type]=\"getSecondaryActionButtonType()\"\n              (p-click)=\"secondaryAction.action()\">\n            </po-button>\n\n            <po-button\n              class=\"po-button-modal-first-action\"\n              [p-disabled]=\"primaryAction.disabled\"\n              [p-label]=\"primaryAction.label\"\n              [p-loading]=\"primaryAction.loading\"\n              [p-type]=\"getPrimaryActionButtonType()\"\n              (p-click)=\"primaryAction.action()\">\n            </po-button>\n          </div>\n\n        </div>\n      </div>\n\n    </div>\n  </div>\n</div>\n\n"
            }] }
];
/** @nocollapse */
PoModalComponent.ctorParameters = () => [
    { type: PoModalService },
    { type: Renderer2 },
    { type: ChangeDetectorRef }
];
PoModalComponent.propDecorators = {
    modalContent: [{ type: ViewChild, args: ['modalContent', { read: ElementRef, static: false },] }]
};
if (false) {
    /** @type {?} */
    PoModalComponent.prototype.modalContent;
    /**
     * @type {?}
     * @private
     */
    PoModalComponent.prototype.firstElement;
    /**
     * @type {?}
     * @private
     */
    PoModalComponent.prototype.focusFunction;
    /**
     * @type {?}
     * @private
     */
    PoModalComponent.prototype.focusableElements;
    /**
     * @type {?}
     * @private
     */
    PoModalComponent.prototype.id;
    /**
     * @type {?}
     * @private
     */
    PoModalComponent.prototype.sourceElement;
    /** @type {?} */
    PoModalComponent.prototype.onResizeListener;
    /**
     * @type {?}
     * @private
     */
    PoModalComponent.prototype.poModalService;
    /**
     * @type {?}
     * @private
     */
    PoModalComponent.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    PoModalComponent.prototype.changeDetector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBvcnRpbmFyaS9wb3J0aW5hcmktdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wby1tb2RhbC9wby1tb2RhbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFL0YsT0FBTyxFQUFFLEVBQUUsSUFBSSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFbEMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUEyQnBELE1BQU0sT0FBTyxnQkFBaUIsU0FBUSxvQkFBb0I7Ozs7OztJQVl4RCxZQUFvQixjQUE4QixFQUFVLFFBQW1CLEVBQVUsY0FBaUM7UUFDeEgsS0FBSyxFQUFFLENBQUM7UUFEVSxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQW1CO1FBTmxILHNCQUFpQixHQUFHLG9EQUFvRCxDQUFDO1FBQ3pFLE9BQUUsR0FBVyxJQUFJLEVBQUUsQ0FBQztJQU81QixDQUFDOzs7OztJQUVELEtBQUssQ0FBQyxPQUFPLEdBQUcsS0FBSztRQUNuQixJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsR0FBRyxTQUFTLENBQUM7UUFFNUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVyQixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUU1QixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUM1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Q0FBQztJQUNsRSxDQUFDOzs7OztJQUVPLGVBQWU7UUFDckIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUM7SUFDL0gsQ0FBQzs7O1lBdEdGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsVUFBVTtnQkFDcEIsOHZEQUF3QzthQUN6Qzs7OztZQTFCUSxjQUFjO1lBTDRCLFNBQVM7WUFBbkQsaUJBQWlCOzs7MkJBa0N2QixTQUFTLFNBQUMsY0FBYyxFQUFFLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFOzs7O0lBQTlELHdDQUF5Rjs7Ozs7SUFFekYsd0NBQXFCOzs7OztJQUNyQix5Q0FBc0I7Ozs7O0lBQ3RCLDZDQUFpRjs7Ozs7SUFDakYsOEJBQTRCOzs7OztJQUM1Qix5Q0FBc0I7O0lBRXRCLDRDQUE2Qjs7Ozs7SUFFakIsMENBQXNDOzs7OztJQUFFLG9DQUEyQjs7Ozs7SUFBRSwwQ0FBeUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBSZW5kZXJlcjIsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyB2NCBhcyB1dWlkIH0gZnJvbSAndXVpZCc7XG5cbmltcG9ydCB7IFBvTW9kYWxCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1tb2RhbC1iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb01vZGFsU2VydmljZSB9IGZyb20gJy4vcG8tbW9kYWwtc2VydmljZSc7XG5cbi8qKlxuICogQGRvY3NFeHRlbmRzIFBvTW9kYWxCYXNlQ29tcG9uZW50XG4gKlxuICogQGV4YW1wbGVcbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tbW9kYWwtYmFzaWNcIiB0aXRsZT1cIlBvcnRpbmFyaSBNb2RhbCBCYXNpY1wiPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tbW9kYWwtYmFzaWMvc2FtcGxlLXBvLW1vZGFsLWJhc2ljLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLW1vZGFsLWJhc2ljL3NhbXBsZS1wby1tb2RhbC1iYXNpYy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1tb2RhbC1sYWJzXCIgdGl0bGU9XCJQb3J0aW5hcmkgTW9kYWwgTGFic1wiPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tbW9kYWwtbGFicy9zYW1wbGUtcG8tbW9kYWwtbGFicy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1tb2RhbC1sYWJzL3NhbXBsZS1wby1tb2RhbC1sYWJzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLW1vZGFsLWZydWl0cy1zYWxhZFwiIHRpdGxlPVwiUG9ydGluYXJpIE1vZGFsIC0gRnJ1aXRzIFNhbGFkXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1tb2RhbC1mcnVpdHMtc2FsYWQvc2FtcGxlLXBvLW1vZGFsLWZydWl0cy1zYWxhZC5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1tb2RhbC1mcnVpdHMtc2FsYWQvc2FtcGxlLXBvLW1vZGFsLWZydWl0cy1zYWxhZC5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICovXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLW1vZGFsJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLW1vZGFsLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQb01vZGFsQ29tcG9uZW50IGV4dGVuZHMgUG9Nb2RhbEJhc2VDb21wb25lbnQge1xuXG4gIEBWaWV3Q2hpbGQoJ21vZGFsQ29udGVudCcsIHsgcmVhZDogRWxlbWVudFJlZiwgc3RhdGljOiBmYWxzZSB9KSBtb2RhbENvbnRlbnQ6IEVsZW1lbnRSZWY7XG5cbiAgcHJpdmF0ZSBmaXJzdEVsZW1lbnQ7XG4gIHByaXZhdGUgZm9jdXNGdW5jdGlvbjtcbiAgcHJpdmF0ZSBmb2N1c2FibGVFbGVtZW50cyA9ICdpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYnV0dG9uOm5vdChbZGlzYWJsZWRdKSwgYSc7XG4gIHByaXZhdGUgaWQ6IHN0cmluZyA9IHV1aWQoKTtcbiAgcHJpdmF0ZSBzb3VyY2VFbGVtZW50O1xuXG4gIG9uUmVzaXplTGlzdGVuZXI6ICgpID0+IHZvaWQ7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwb01vZGFsU2VydmljZTogUG9Nb2RhbFNlcnZpY2UsIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWYpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgY2xvc2UoeENsb3NlZCA9IGZhbHNlKSB7XG4gICAgdGhpcy5wb01vZGFsU2VydmljZS5tb2RhbEFjdGl2ZSA9IHVuZGVmaW5lZDtcblxuICAgIHN1cGVyLmNsb3NlKHhDbG9zZWQpO1xuXG4gICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVycygpO1xuXG4gICAgaWYgKHRoaXMuc291cmNlRWxlbWVudCkge1xuICAgICAgdGhpcy5zb3VyY2VFbGVtZW50LmZvY3VzKCk7XG4gICAgfVxuICB9XG5cbiAgY2xvc2VNb2RhbE9uRXNjYXBlS2V5KGV2ZW50KSB7XG4gICAgaWYgKCF0aGlzLmhpZGVDbG9zZSkge1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgdGhpcy5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIGdldFByaW1hcnlBY3Rpb25CdXR0b25UeXBlKCkge1xuICAgIHJldHVybiB0aGlzLnByaW1hcnlBY3Rpb24uZGFuZ2VyID8gJ2RhbmdlcicgOiAncHJpbWFyeSc7XG4gIH1cblxuICBnZXRTZWNvbmRhcnlBY3Rpb25CdXR0b25UeXBlKCkge1xuICAgIHJldHVybiB0aGlzLnNlY29uZGFyeUFjdGlvbiAmJiB0aGlzLnNlY29uZGFyeUFjdGlvbi5kYW5nZXIgJiYgIXRoaXMucHJpbWFyeUFjdGlvbi5kYW5nZXIgPyAnZGFuZ2VyJyA6ICdkZWZhdWx0JztcbiAgfVxuXG4gIG9uQ2xpY2tPdXQoZXZlbnQpIHtcbiAgICBpZiAodGhpcy5jbGlja091dCAmJiAhdGhpcy5tb2RhbENvbnRlbnQubmF0aXZlRWxlbWVudC5jb250YWlucyhldmVudC50YXJnZXQpKSB7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgb3BlbigpIHtcbiAgICB0aGlzLnNvdXJjZUVsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50O1xuXG4gICAgc3VwZXIub3BlbigpO1xuXG4gICAgdGhpcy5oYW5kbGVGb2N1cygpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVGb2N1cygpOiBhbnkge1xuICAgIHRoaXMucG9Nb2RhbFNlcnZpY2UubW9kYWxBY3RpdmUgPSB0aGlzLmlkO1xuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5tb2RhbENvbnRlbnQpIHtcbiAgICAgICAgdGhpcy5pbml0Rm9jdXMoKTtcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCB0aGlzLmZvY3VzRnVuY3Rpb24sIHRydWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0Rm9jdXMoKSB7XG4gICAgdGhpcy5mb2N1c0Z1bmN0aW9uID0gKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgIHRoaXMucG9Nb2RhbFNlcnZpY2UubW9kYWxBY3RpdmUgPSB0aGlzLnBvTW9kYWxTZXJ2aWNlLm1vZGFsQWN0aXZlIHx8IHRoaXMuaWQ7XG4gICAgICBjb25zdCBtb2RhbEVsZW1lbnQgPSB0aGlzLm1vZGFsQ29udGVudC5uYXRpdmVFbGVtZW50O1xuXG4gICAgICBpZiAoIW1vZGFsRWxlbWVudC5jb250YWlucyhldmVudC50YXJnZXQpICYmIHRoaXMucG9Nb2RhbFNlcnZpY2UubW9kYWxBY3RpdmUgPT09IHRoaXMuaWQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuZmlyc3RFbGVtZW50LmZvY3VzKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMuc2V0Rmlyc3RFbGVtZW50KCk7XG5cbiAgICBpZiAodGhpcy5oaWRlQ2xvc2UpIHtcbiAgICAgIHRoaXMuZmlyc3RFbGVtZW50LmZvY3VzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGZpcnN0RmllbGRFbGVtZW50ID1cbiAgICAgICAgdGhpcy5tb2RhbENvbnRlbnQubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHRoaXMuZm9jdXNhYmxlRWxlbWVudHMpWzFdIHx8XG4gICAgICAgIHRoaXMubW9kYWxDb250ZW50Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgICBmaXJzdEZpZWxkRWxlbWVudC5mb2N1cygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRXZlbnRMaXN0ZW5lcnMoKSB7XG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignZm9jdXMnLCB0aGlzLmZvY3VzRnVuY3Rpb24sIHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRGaXJzdEVsZW1lbnQoKSB7XG4gICAgdGhpcy5maXJzdEVsZW1lbnQgPSB0aGlzLm1vZGFsQ29udGVudC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5mb2N1c2FibGVFbGVtZW50cykgfHwgdGhpcy5tb2RhbENvbnRlbnQubmF0aXZlRWxlbWVudDtcbiAgfVxuXG59XG4iXX0=