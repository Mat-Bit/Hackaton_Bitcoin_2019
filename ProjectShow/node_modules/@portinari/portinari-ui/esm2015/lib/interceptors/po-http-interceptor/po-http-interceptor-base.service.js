/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { HttpResponse } from '@angular/common/http';
import { tap } from 'rxjs/operators';
/** @type {?} */
const NO_ERROR_HEADER_PARAM = 'X-Portinari-No-Error';
/**
 * \@description
 *
 * O serviço Portinari Http Interceptor realiza o tratamento de requisições HTTP conforme o padrão do
 * [**Guia de implementação das APIs TOTVS**](http://tdn.totvs.com/pages/viewpage.action?pageId=484701395) para adaptá-lo
 * ao modelo do PO.
 *
 * Ao analisar o objeto `_messages` retornado pela requisição, o serviço exibirá notificações com mensagens na tela.
 * Os retornos de erros com códigos 4xx e 5xx são tratados automaticamente, sem a necessidade de incluir o `_messages`.
 *
 * Também existe a possibilidade de não apresentar a notificação quando houver algum erro com códigos 4xx e 5xx,
 * utilizando o parâmetro `X-Portinari-No-Error` que foi definido conforme o
 * [**Guia de implementação das APIs TOTVS**](http://tdn.totvs.com/pages/viewpage.action?pageId=484701395) (em Cabeçalhos Customizados).
 * O parâmetro `X-Portinari-No-Error` deve ser informado no cabeçalho da requisição com o valor `'true'` para funcionar corretamente,
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Portinari-No-Error': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * > Após a validação no interceptor, o parâmetro será removido do cabeçalho da requisição.
 *
 * O `Content-Type` deve ser `application/json` e a estrutura de mensagem recebida pelo serviço deve seguir o
 * [**Guia de implementação das APIs TOTVS**](http://tdn.totvs.com/pages/viewpage.action?pageId=484701395)
 * (em Mensagens de sucesso para coleções), exemplo:
 *  - _messages: lista de mensagens de erro ou informativo resultante do serviço.
 *    - type: success, warning, error, e information;
 *    - code: título ou código da mensagem;
 *    - message: texto da mensagem;
 *    - detailedMessage: detalhamento do erro ou informativo;
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 * Ao realizar requisições utilize o `HttpClient`, conforme exemplo abaixo:
 *
 * ```
 * import { HttpClient } from '\@angular/common/http';
 *
 * ...
 *
 * \@Injectable()
 * export class UserService {
 *
 *   constructor(private http: HttpClient) { }
 *
 *   getUsers() {
 *     return this.http.get('/api/users');
 *   }
 *
 *   ...
 *
 * }
 * ```
 *
 * @abstract
 */
export class PoHttpInterceptorBaseService {
    /**
     * @param {?} notification
     * @param {?} dialog
     */
    constructor(notification, dialog) {
        this.notification = notification;
        this.dialog = dialog;
        this.notificationTypes = ['success', 'warning', 'error', 'information'];
    }
    /**
     * @param {?} request
     * @param {?} next
     * @return {?}
     */
    intercept(request, next) {
        /** @type {?} */
        const cloneRequest = request.clone();
        request = request.headers.has(NO_ERROR_HEADER_PARAM) ? this.cloneRequestWithoutNoErrorHeaderParam(request) : request;
        return next.handle(request).pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        (response) => {
            if (response instanceof HttpResponse) {
                this.processResponse(response);
            }
        }), (/**
         * @param {?} error
         * @return {?}
         */
        (error) => {
            this.processErrorResponse(error, cloneRequest);
        })));
    }
    /**
     * @param {?} response
     * @return {?}
     */
    processResponse(response) {
        if (response.body && response.body._messages) {
            /** @type {?} */
            const messages = response.body._messages;
            if (messages instanceof Array) {
                messages.forEach((/**
                 * @param {?} message
                 * @return {?}
                 */
                (message) => {
                    this.showNotification(message);
                }));
            }
            else {
                this.showNotification(messages);
            }
        }
    }
    /**
     * @param {?} response
     * @param {?} request
     * @return {?}
     */
    processErrorResponse(response, request) {
        /** @type {?} */
        const errorResponse = response.status !== 0
            ? response.error
            : { code: 0, message: 'Servidor não está respondendo.', detailedMessage: response.message };
        /** @type {?} */
        const hasNoErrorParam = this.hasNoErrorParam(request);
        // not show the notification when has NoError parameter on header of request.
        if (errorResponse && errorResponse.message && !hasNoErrorParam) {
            this.showNotification(Object.assign({}, errorResponse, { type: 'error' }));
        }
    }
    /**
     * @private
     * @param {?} request
     * @return {?}
     */
    cloneRequestWithoutNoErrorHeaderParam(request) {
        return request && request.clone({ headers: request.headers.delete(NO_ERROR_HEADER_PARAM) });
    }
    /**
     * @private
     * @param {?} request
     * @return {?}
     */
    hasNoErrorParam(request) {
        /** @type {?} */
        const noErrorParam = request && request.headers.get(NO_ERROR_HEADER_PARAM);
        return noErrorParam && noErrorParam.toString().toLocaleLowerCase() === 'true';
    }
    /**
     * @private
     * @param {?} response
     * @return {?}
     */
    showNotification(response) {
        /** @type {?} */
        const typeNotification = this.notificationTypes.includes(response.type) ? response.type : 'information';
        /** @type {?} */
        const notificationAction = this.generateNotificationAction(response);
        this.notification[typeNotification]({
            message: response.message,
            actionLabel: notificationAction.label,
            action: notificationAction.action
        });
    }
    /**
     * @private
     * @param {?} errorResponse
     * @return {?}
     */
    generateNotificationAction(errorResponse) {
        /** @type {?} */
        let notificationAction;
        /** @type {?} */
        let notificationLabel;
        /** @type {?} */
        let notificationMessage = errorResponse.message.concat(` ${errorResponse.detailedMessage}`);
        if (errorResponse.details && errorResponse.details instanceof Array) {
            errorResponse.details.forEach((/**
             * @param {?} detailError
             * @return {?}
             */
            (detailError) => {
                notificationMessage += `\n${detailError.message}`;
            }));
        }
        if (errorResponse.helpUrl && !(errorResponse.detailedMessage || errorResponse.details)) {
            notificationLabel = 'Ajuda';
            notificationAction = this.generateUrlHelpFunction(errorResponse.helpUrl);
        }
        else if (errorResponse.detailedMessage || errorResponse.details) {
            notificationLabel = 'Detalhes';
            notificationAction = this.generateDialogDetailFunction(errorResponse, notificationMessage);
        }
        return { label: notificationLabel, action: notificationAction };
    }
    /**
     * @private
     * @param {?} helpUrl
     * @return {?}
     */
    generateUrlHelpFunction(helpUrl) {
        return (/**
         * @return {?}
         */
        () => { window.open(helpUrl, '_blank'); });
    }
    /**
     * @private
     * @param {?} errorResponse
     * @param {?} notificationMessage
     * @return {?}
     */
    generateDialogDetailFunction(errorResponse, notificationMessage) {
        return (/**
         * @return {?}
         */
        () => {
            this.dialog.alert({
                title: errorResponse.code,
                message: notificationMessage,
                ok: errorResponse.helpUrl ? this.generateUrlHelpFunction(errorResponse.helpUrl) : undefined
            });
        });
    }
}
if (false) {
    /** @type {?} */
    PoHttpInterceptorBaseService.prototype.notificationTypes;
    /**
     * @type {?}
     * @private
     */
    PoHttpInterceptorBaseService.prototype.notification;
    /**
     * @type {?}
     * @private
     */
    PoHttpInterceptorBaseService.prototype.dialog;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1pbnRlcmNlcHRvci1iYXNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS11aS8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvcG8taHR0cC1pbnRlcmNlcHRvci9wby1odHRwLWludGVyY2VwdG9yLWJhc2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUE2QyxZQUFZLEVBQWdDLE1BQU0sc0JBQXNCLENBQUM7QUFHN0gsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOztNQUUvQixxQkFBcUIsR0FBRyxzQkFBc0I7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBOERwRCxNQUFNLE9BQWdCLDRCQUE0Qjs7Ozs7SUFJaEQsWUFBb0IsWUFBaUIsRUFBVSxNQUFXO1FBQXRDLGlCQUFZLEdBQVosWUFBWSxDQUFLO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBSztRQUYxRCxzQkFBaUIsR0FBRyxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBRUwsQ0FBQzs7Ozs7O0lBRS9ELFNBQVMsQ0FBQyxPQUF5QixFQUFFLElBQWlCOztjQUM5QyxZQUFZLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRTtRQUVwQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLHFDQUFxQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFFckgsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHOzs7O1FBQUMsQ0FBQyxRQUF3QixFQUFFLEVBQUU7WUFFaEUsSUFBSSxRQUFRLFlBQVksWUFBWSxFQUFFO2dCQUVwQyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBRWhDO1FBQ0gsQ0FBQzs7OztRQUFFLENBQUMsS0FBd0IsRUFBRSxFQUFFO1lBRTlCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFFakQsQ0FBQyxFQUFDLENBQUMsQ0FBQztJQUNOLENBQUM7Ozs7O0lBRUQsZUFBZSxDQUFDLFFBQTJCO1FBQ3pDLElBQUksUUFBUSxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTs7a0JBRXRDLFFBQVEsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVM7WUFFeEMsSUFBSSxRQUFRLFlBQVksS0FBSyxFQUFFO2dCQUM3QixRQUFRLENBQUMsT0FBTzs7OztnQkFBQyxDQUFDLE9BQVksRUFBRSxFQUFFO29CQUNoQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ2pDLENBQUMsRUFBQyxDQUFDO2FBQ0o7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2pDO1NBQ0Y7SUFDSCxDQUFDOzs7Ozs7SUFFRCxvQkFBb0IsQ0FBQyxRQUEyQixFQUFFLE9BQXlCOztjQUNuRSxhQUFhLEdBQUcsUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQ3pDLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSztZQUNoQixDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxlQUFlLEVBQUUsUUFBUSxDQUFDLE9BQU8sRUFBRTs7Y0FFdkYsZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDO1FBRXJELDZFQUE2RTtRQUM3RSxJQUFJLGFBQWEsSUFBSSxhQUFhLENBQUMsT0FBTyxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQzlELElBQUksQ0FBQyxnQkFBZ0IsbUJBQU0sYUFBYSxJQUFFLElBQUksRUFBRSxPQUFPLElBQUcsQ0FBQztTQUM1RDtJQUNILENBQUM7Ozs7OztJQUVPLHFDQUFxQyxDQUFDLE9BQXlCO1FBQ3JFLE9BQU8sT0FBTyxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsRUFBQyxDQUFDLENBQUM7SUFDNUYsQ0FBQzs7Ozs7O0lBRU8sZUFBZSxDQUFDLE9BQXlCOztjQUN6QyxZQUFZLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDO1FBRTFFLE9BQU8sWUFBWSxJQUFJLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLE1BQU0sQ0FBQztJQUNoRixDQUFDOzs7Ozs7SUFFTyxnQkFBZ0IsQ0FBQyxRQUFhOztjQUM5QixnQkFBZ0IsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsYUFBYTs7Y0FFakcsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLDBCQUEwQixDQUFDLFFBQVEsQ0FBQztRQUVwRSxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDbEMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxPQUFPO1lBQ3pCLFdBQVcsRUFBRSxrQkFBa0IsQ0FBQyxLQUFLO1lBQ3JDLE1BQU0sRUFBRSxrQkFBa0IsQ0FBQyxNQUFNO1NBQ2xDLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7OztJQUVPLDBCQUEwQixDQUFDLGFBQWtCOztZQUUvQyxrQkFBa0I7O1lBQ2xCLGlCQUFpQjs7WUFFakIsbUJBQW1CLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxhQUFhLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFM0YsSUFBSSxhQUFhLENBQUMsT0FBTyxJQUFJLGFBQWEsQ0FBQyxPQUFPLFlBQVksS0FBSyxFQUFFO1lBQ25FLGFBQWEsQ0FBQyxPQUFPLENBQUMsT0FBTzs7OztZQUFDLENBQUMsV0FBZ0IsRUFBRSxFQUFFO2dCQUNqRCxtQkFBbUIsSUFBSSxLQUFLLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNwRCxDQUFDLEVBQUMsQ0FBQztTQUNKO1FBRUQsSUFBSSxhQUFhLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxhQUFhLENBQUMsZUFBZSxJQUFJLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUN0RixpQkFBaUIsR0FBRyxPQUFPLENBQUM7WUFDNUIsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUUxRTthQUFNLElBQUksYUFBYSxDQUFDLGVBQWUsSUFBSSxhQUFhLENBQUMsT0FBTyxFQUFFO1lBQ2pFLGlCQUFpQixHQUFHLFVBQVUsQ0FBQztZQUMvQixrQkFBa0IsR0FBRyxJQUFJLENBQUMsNEJBQTRCLENBQUMsYUFBYSxFQUFFLG1CQUFtQixDQUFDLENBQUM7U0FDNUY7UUFDRCxPQUFPLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxDQUFDO0lBQ2xFLENBQUM7Ozs7OztJQUVPLHVCQUF1QixDQUFDLE9BQWU7UUFDN0M7OztRQUFPLEdBQUcsRUFBRSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFDO0lBQ25ELENBQUM7Ozs7Ozs7SUFFTyw0QkFBNEIsQ0FBQyxhQUFrQixFQUFFLG1CQUEyQjtRQUNsRjs7O1FBQU8sR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7Z0JBQ2hCLEtBQUssRUFBRSxhQUFhLENBQUMsSUFBSTtnQkFDekIsT0FBTyxFQUFFLG1CQUFtQjtnQkFDNUIsRUFBRSxFQUFFLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVM7YUFDNUYsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxFQUFDO0lBQ0osQ0FBQztDQUNGOzs7SUE5R0MseURBQW1FOzs7OztJQUV2RCxvREFBeUI7Ozs7O0lBQUUsOENBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cEludGVyY2VwdG9yLCBIdHRwSGFuZGxlciwgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZSwgSHR0cEV2ZW50LCBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5jb25zdCBOT19FUlJPUl9IRUFERVJfUEFSQU0gPSAnWC1Qb3J0aW5hcmktTm8tRXJyb3InO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIE8gc2VydmnDp28gUG9ydGluYXJpIEh0dHAgSW50ZXJjZXB0b3IgcmVhbGl6YSBvIHRyYXRhbWVudG8gZGUgcmVxdWlzacOnw7VlcyBIVFRQIGNvbmZvcm1lIG8gcGFkcsOjbyBkb1xuICogWyoqR3VpYSBkZSBpbXBsZW1lbnRhw6fDo28gZGFzIEFQSXMgVE9UVlMqKl0oaHR0cDovL3Rkbi50b3R2cy5jb20vcGFnZXMvdmlld3BhZ2UuYWN0aW9uP3BhZ2VJZD00ODQ3MDEzOTUpIHBhcmEgYWRhcHTDoS1sb1xuICogYW8gbW9kZWxvIGRvIFBPLlxuICpcbiAqIEFvIGFuYWxpc2FyIG8gb2JqZXRvIGBfbWVzc2FnZXNgIHJldG9ybmFkbyBwZWxhIHJlcXVpc2nDp8OjbywgbyBzZXJ2acOnbyBleGliaXLDoSBub3RpZmljYcOnw7VlcyBjb20gbWVuc2FnZW5zIG5hIHRlbGEuXG4gKiBPcyByZXRvcm5vcyBkZSBlcnJvcyBjb20gY8OzZGlnb3MgNHh4IGUgNXh4IHPDo28gdHJhdGFkb3MgYXV0b21hdGljYW1lbnRlLCBzZW0gYSBuZWNlc3NpZGFkZSBkZSBpbmNsdWlyIG8gYF9tZXNzYWdlc2AuXG4gKlxuICogVGFtYsOpbSBleGlzdGUgYSBwb3NzaWJpbGlkYWRlIGRlIG7Do28gYXByZXNlbnRhciBhIG5vdGlmaWNhw6fDo28gcXVhbmRvIGhvdXZlciBhbGd1bSBlcnJvIGNvbSBjw7NkaWdvcyA0eHggZSA1eHgsXG4gKiB1dGlsaXphbmRvIG8gcGFyw6JtZXRybyBgWC1Qb3J0aW5hcmktTm8tRXJyb3JgIHF1ZSBmb2kgZGVmaW5pZG8gY29uZm9ybWUgb1xuICogWyoqR3VpYSBkZSBpbXBsZW1lbnRhw6fDo28gZGFzIEFQSXMgVE9UVlMqKl0oaHR0cDovL3Rkbi50b3R2cy5jb20vcGFnZXMvdmlld3BhZ2UuYWN0aW9uP3BhZ2VJZD00ODQ3MDEzOTUpIChlbSBDYWJlw6dhbGhvcyBDdXN0b21pemFkb3MpLlxuICogTyBwYXLDom1ldHJvIGBYLVBvcnRpbmFyaS1Oby1FcnJvcmAgZGV2ZSBzZXIgaW5mb3JtYWRvIG5vIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvIGNvbSBvIHZhbG9yIGAndHJ1ZSdgIHBhcmEgZnVuY2lvbmFyIGNvcnJldGFtZW50ZSxcbiAqIHBvciBleGVtcGxvOlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUG9ydGluYXJpLU5vLUVycm9yJzogJ3RydWUnIH07XG4gKlxuICogIHRoaXMuaHR0cC5nZXQoYC9jdXN0b21lcnMvMWAsIHsgaGVhZGVyczogaGVhZGVycyB9KTtcbiAqIC4uLlxuICpcbiAqIGBgYFxuICogPiBBcMOzcyBhIHZhbGlkYcOnw6NvIG5vIGludGVyY2VwdG9yLCBvIHBhcsOibWV0cm8gc2Vyw6EgcmVtb3ZpZG8gZG8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28uXG4gKlxuICogTyBgQ29udGVudC1UeXBlYCBkZXZlIHNlciBgYXBwbGljYXRpb24vanNvbmAgZSBhIGVzdHJ1dHVyYSBkZSBtZW5zYWdlbSByZWNlYmlkYSBwZWxvIHNlcnZpw6dvIGRldmUgc2VndWlyIG9cbiAqIFsqKkd1aWEgZGUgaW1wbGVtZW50YcOnw6NvIGRhcyBBUElzIFRPVFZTKipdKGh0dHA6Ly90ZG4udG90dnMuY29tL3BhZ2VzL3ZpZXdwYWdlLmFjdGlvbj9wYWdlSWQ9NDg0NzAxMzk1KVxuICogKGVtIE1lbnNhZ2VucyBkZSBzdWNlc3NvIHBhcmEgY29sZcOnw7VlcyksIGV4ZW1wbG86XG4gKiAgLSBfbWVzc2FnZXM6IGxpc3RhIGRlIG1lbnNhZ2VucyBkZSBlcnJvIG91IGluZm9ybWF0aXZvIHJlc3VsdGFudGUgZG8gc2VydmnDp28uXG4gKiAgICAtIHR5cGU6IHN1Y2Nlc3MsIHdhcm5pbmcsIGVycm9yLCBlIGluZm9ybWF0aW9uO1xuICogICAgLSBjb2RlOiB0w610dWxvIG91IGPDs2RpZ28gZGEgbWVuc2FnZW07XG4gKiAgICAtIG1lc3NhZ2U6IHRleHRvIGRhIG1lbnNhZ2VtO1xuICogICAgLSBkZXRhaWxlZE1lc3NhZ2U6IGRldGFsaGFtZW50byBkbyBlcnJvIG91IGluZm9ybWF0aXZvO1xuICpcbiAqIEFvIGltcG9ydGFyIG8gbcOzZHVsbyBgUG9Nb2R1bGVgIG5hIGFwbGljYcOnw6NvLCBvIGBwby1odHRwLWludGVyY2VwdG9yYCDDqSBhdXRvbWF0aWNhbWVudGUgY29uZmlndXJhZG8gc2VtIGEgbmVjZXNzaWRhZGVcbiAqIGRlIHF1YWxxdWVyIGNvbmZpZ3VyYcOnw6NvIGV4dHJhLlxuICpcbiAqIEFvIHJlYWxpemFyIHJlcXVpc2nDp8O1ZXMgdXRpbGl6ZSBvIGBIdHRwQ2xpZW50YCwgY29uZm9ybWUgZXhlbXBsbyBhYmFpeG86XG4gKlxuICogYGBgXG4gKiBpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuICpcbiAqIC4uLlxuICpcbiAqIEBJbmplY3RhYmxlKClcbiAqIGV4cG9ydCBjbGFzcyBVc2VyU2VydmljZSB7XG4gKlxuICogICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHsgfVxuICpcbiAqICAgZ2V0VXNlcnMoKSB7XG4gKiAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoJy9hcGkvdXNlcnMnKTtcbiAqICAgfVxuICpcbiAqICAgLi4uXG4gKlxuICogfVxuICogYGBgXG4gKlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUG9IdHRwSW50ZXJjZXB0b3JCYXNlU2VydmljZSBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG5cbiAgbm90aWZpY2F0aW9uVHlwZXMgPSBbJ3N1Y2Nlc3MnLCAnd2FybmluZycsICdlcnJvcicsICdpbmZvcm1hdGlvbiddO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbm90aWZpY2F0aW9uOiBhbnksIHByaXZhdGUgZGlhbG9nOiBhbnkpIHsgfVxuXG4gIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBjb25zdCBjbG9uZVJlcXVlc3QgPSByZXF1ZXN0LmNsb25lKCk7XG5cbiAgICByZXF1ZXN0ID0gcmVxdWVzdC5oZWFkZXJzLmhhcyhOT19FUlJPUl9IRUFERVJfUEFSQU0pID8gdGhpcy5jbG9uZVJlcXVlc3RXaXRob3V0Tm9FcnJvckhlYWRlclBhcmFtKHJlcXVlc3QpIDogcmVxdWVzdDtcblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKHRhcCgocmVzcG9uc2U6IEh0dHBFdmVudDxhbnk+KSA9PiB7XG5cbiAgICAgIGlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xuXG4gICAgICAgIHRoaXMucHJvY2Vzc1Jlc3BvbnNlKHJlc3BvbnNlKTtcblxuICAgICAgfVxuICAgIH0sIChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcblxuICAgICAgdGhpcy5wcm9jZXNzRXJyb3JSZXNwb25zZShlcnJvciwgY2xvbmVSZXF1ZXN0KTtcblxuICAgIH0pKTtcbiAgfVxuXG4gIHByb2Nlc3NSZXNwb25zZShyZXNwb25zZTogSHR0cFJlc3BvbnNlPGFueT4pIHtcbiAgICBpZiAocmVzcG9uc2UuYm9keSAmJiByZXNwb25zZS5ib2R5Ll9tZXNzYWdlcykge1xuXG4gICAgICBjb25zdCBtZXNzYWdlcyA9IHJlc3BvbnNlLmJvZHkuX21lc3NhZ2VzO1xuXG4gICAgICBpZiAobWVzc2FnZXMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICBtZXNzYWdlcy5mb3JFYWNoKChtZXNzYWdlOiBhbnkpID0+IHtcbiAgICAgICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24obWVzc2FnZSk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2VzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm9jZXNzRXJyb3JSZXNwb25zZShyZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2UsIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBjb25zdCBlcnJvclJlc3BvbnNlID0gcmVzcG9uc2Uuc3RhdHVzICE9PSAwXG4gICAgICA/IHJlc3BvbnNlLmVycm9yXG4gICAgICA6IHsgY29kZTogMCwgbWVzc2FnZTogJ1NlcnZpZG9yIG7Do28gZXN0w6EgcmVzcG9uZGVuZG8uJywgZGV0YWlsZWRNZXNzYWdlOiByZXNwb25zZS5tZXNzYWdlIH07XG5cbiAgICBjb25zdCBoYXNOb0Vycm9yUGFyYW0gPSB0aGlzLmhhc05vRXJyb3JQYXJhbShyZXF1ZXN0KTtcblxuICAgIC8vIG5vdCBzaG93IHRoZSBub3RpZmljYXRpb24gd2hlbiBoYXMgTm9FcnJvciBwYXJhbWV0ZXIgb24gaGVhZGVyIG9mIHJlcXVlc3QuXG4gICAgaWYgKGVycm9yUmVzcG9uc2UgJiYgZXJyb3JSZXNwb25zZS5tZXNzYWdlICYmICFoYXNOb0Vycm9yUGFyYW0pIHtcbiAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7IC4uLmVycm9yUmVzcG9uc2UsIHR5cGU6ICdlcnJvcicgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjbG9uZVJlcXVlc3RXaXRob3V0Tm9FcnJvckhlYWRlclBhcmFtKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBIdHRwUmVxdWVzdDxhbnk+IHtcbiAgICByZXR1cm4gcmVxdWVzdCAmJiByZXF1ZXN0LmNsb25lKHtoZWFkZXJzOiByZXF1ZXN0LmhlYWRlcnMuZGVsZXRlKE5PX0VSUk9SX0hFQURFUl9QQVJBTSl9KTtcbiAgfVxuXG4gIHByaXZhdGUgaGFzTm9FcnJvclBhcmFtKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBib29sZWFuIHtcbiAgICBjb25zdCBub0Vycm9yUGFyYW0gPSByZXF1ZXN0ICYmIHJlcXVlc3QuaGVhZGVycy5nZXQoTk9fRVJST1JfSEVBREVSX1BBUkFNKTtcblxuICAgIHJldHVybiBub0Vycm9yUGFyYW0gJiYgbm9FcnJvclBhcmFtLnRvU3RyaW5nKCkudG9Mb2NhbGVMb3dlckNhc2UoKSA9PT0gJ3RydWUnO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG93Tm90aWZpY2F0aW9uKHJlc3BvbnNlOiBhbnkpIHtcbiAgICBjb25zdCB0eXBlTm90aWZpY2F0aW9uID0gdGhpcy5ub3RpZmljYXRpb25UeXBlcy5pbmNsdWRlcyhyZXNwb25zZS50eXBlKSA/IHJlc3BvbnNlLnR5cGUgOiAnaW5mb3JtYXRpb24nO1xuXG4gICAgY29uc3Qgbm90aWZpY2F0aW9uQWN0aW9uID0gdGhpcy5nZW5lcmF0ZU5vdGlmaWNhdGlvbkFjdGlvbihyZXNwb25zZSk7XG5cbiAgICB0aGlzLm5vdGlmaWNhdGlvblt0eXBlTm90aWZpY2F0aW9uXSh7XG4gICAgICBtZXNzYWdlOiByZXNwb25zZS5tZXNzYWdlLFxuICAgICAgYWN0aW9uTGFiZWw6IG5vdGlmaWNhdGlvbkFjdGlvbi5sYWJlbCxcbiAgICAgIGFjdGlvbjogbm90aWZpY2F0aW9uQWN0aW9uLmFjdGlvblxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZU5vdGlmaWNhdGlvbkFjdGlvbihlcnJvclJlc3BvbnNlOiBhbnkpIHtcblxuICAgIGxldCBub3RpZmljYXRpb25BY3Rpb247XG4gICAgbGV0IG5vdGlmaWNhdGlvbkxhYmVsO1xuXG4gICAgbGV0IG5vdGlmaWNhdGlvbk1lc3NhZ2UgPSBlcnJvclJlc3BvbnNlLm1lc3NhZ2UuY29uY2F0KGAgJHtlcnJvclJlc3BvbnNlLmRldGFpbGVkTWVzc2FnZX1gKTtcblxuICAgIGlmIChlcnJvclJlc3BvbnNlLmRldGFpbHMgJiYgZXJyb3JSZXNwb25zZS5kZXRhaWxzIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgIGVycm9yUmVzcG9uc2UuZGV0YWlscy5mb3JFYWNoKChkZXRhaWxFcnJvcjogYW55KSA9PiB7XG4gICAgICAgIG5vdGlmaWNhdGlvbk1lc3NhZ2UgKz0gYFxcbiR7ZGV0YWlsRXJyb3IubWVzc2FnZX1gO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGVycm9yUmVzcG9uc2UuaGVscFVybCAmJiAhKGVycm9yUmVzcG9uc2UuZGV0YWlsZWRNZXNzYWdlIHx8IGVycm9yUmVzcG9uc2UuZGV0YWlscykpIHtcbiAgICAgIG5vdGlmaWNhdGlvbkxhYmVsID0gJ0FqdWRhJztcbiAgICAgIG5vdGlmaWNhdGlvbkFjdGlvbiA9IHRoaXMuZ2VuZXJhdGVVcmxIZWxwRnVuY3Rpb24oZXJyb3JSZXNwb25zZS5oZWxwVXJsKTtcblxuICAgIH0gZWxzZSBpZiAoZXJyb3JSZXNwb25zZS5kZXRhaWxlZE1lc3NhZ2UgfHwgZXJyb3JSZXNwb25zZS5kZXRhaWxzKSB7XG4gICAgICBub3RpZmljYXRpb25MYWJlbCA9ICdEZXRhbGhlcyc7XG4gICAgICBub3RpZmljYXRpb25BY3Rpb24gPSB0aGlzLmdlbmVyYXRlRGlhbG9nRGV0YWlsRnVuY3Rpb24oZXJyb3JSZXNwb25zZSwgbm90aWZpY2F0aW9uTWVzc2FnZSk7XG4gICAgfVxuICAgIHJldHVybiB7IGxhYmVsOiBub3RpZmljYXRpb25MYWJlbCwgYWN0aW9uOiBub3RpZmljYXRpb25BY3Rpb24gfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVVcmxIZWxwRnVuY3Rpb24oaGVscFVybDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICgpID0+IHsgd2luZG93Lm9wZW4oaGVscFVybCwgJ19ibGFuaycpOyB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZURpYWxvZ0RldGFpbEZ1bmN0aW9uKGVycm9yUmVzcG9uc2U6IGFueSwgbm90aWZpY2F0aW9uTWVzc2FnZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIHRoaXMuZGlhbG9nLmFsZXJ0KHtcbiAgICAgICAgdGl0bGU6IGVycm9yUmVzcG9uc2UuY29kZSxcbiAgICAgICAgbWVzc2FnZTogbm90aWZpY2F0aW9uTWVzc2FnZSxcbiAgICAgICAgb2s6IGVycm9yUmVzcG9uc2UuaGVscFVybCA/IHRoaXMuZ2VuZXJhdGVVcmxIZWxwRnVuY3Rpb24oZXJyb3JSZXNwb25zZS5oZWxwVXJsKSA6IHVuZGVmaW5lZFxuICAgICAgfSk7XG4gICAgfTtcbiAgfVxufVxuIl19